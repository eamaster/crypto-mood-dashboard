<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç Technical Analysis Module - Crypto Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }

        .header h1 {
            color: #2c3e50;
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .subtitle {
            color: #666;
            font-size: 1.1em;
            margin-bottom: 20px;
        }

        .disclaimer {
            background: linear-gradient(135deg, #ff9a56 0%, #ff6b6b 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: 500;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
        }

        .controls {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            justify-content: flex-start;
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            border: 1px solid #e0e0e0;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .control-group label {
            font-weight: 600;
            color: #555;
            font-size: 0.9em;
        }

        .button-group {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            margin-left: auto;
        }

        select, button {
            padding: 10px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            transition: all 0.3s ease;
        }

        select:focus, button:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            min-width: 120px;
            height: 42px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            border: 1px solid #e0e0e0;
            overflow: hidden;
            position: relative;
        }

        .chart-wrapper {
            width: 100%;
            height: 400px;
            position: relative;
            margin: 15px 0;
        }

        #taChart {
            max-width: 100% !important;
            max-height: 400px !important;
        }

        .indicators-panel {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            border: 1px solid #e0e0e0;
        }

        .indicator {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            background: #f8f9fa;
        }

        .indicator h3 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1.1em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .indicator-value {
            font-size: 1.3em;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .signal {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .signal.buy, .signal.bullish {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }

        .signal.sell, .signal.bearish {
            background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);
            color: white;
        }

        .signal.neutral, .signal.hold {
            background: linear-gradient(135deg, #6c757d 0%, #adb5bd 100%);
            color: white;
        }

        .signal-strength {
            font-size: 0.8em;
            color: #666;
            margin-top: 5px;
        }

        .explanation {
            font-size: 0.85em;
            color: #666;
            margin-top: 8px;
            line-height: 1.4;
        }

        .loading {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 40px;
        }

        .error {
            background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            font-weight: 500;
        }

        .ta-summary {
            background: linear-gradient(135deg, #6c5ce7 0%, #a29bfe 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-top: 20px;
            text-align: center;
        }

        .ta-summary h3 {
            margin-bottom: 10px;
            font-size: 1.3em;
        }

        .overall-signal {
            font-size: 2em;
            font-weight: 700;
            margin: 10px 0;
        }

        .confidence {
            font-size: 0.9em;
            opacity: 0.9;
        }

        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
            
            .controls {
                flex-direction: column;
                align-items: stretch;
                gap: 15px;
            }
            
            .button-group {
                margin-left: 0;
                justify-content: center;
                width: 100%;
            }
            
            .control-group {
                width: 100%;
            }
            
            select {
                width: 100%;
            }
            
            button {
                width: 100%;
                max-width: 200px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .chart-wrapper {
                height: 300px;
            }
            
            #taChart {
                max-height: 300px !important;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 15px;
            }
            
            .chart-wrapper {
                height: 250px;
            }
            
            #taChart {
                max-height: 250px !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç Technical Analysis Module</h1>
            <p class="subtitle">Professional crypto technical indicators and signals</p>
            
            <div class="disclaimer">
                ‚ö†Ô∏è <strong>IMPORTANT DISCLAIMER:</strong> This is for educational purposes only. Technical analysis is not guaranteed to predict future price movements. Cryptocurrency trading involves significant risk of loss. Never invest more than you can afford to lose. This is NOT financial advice. Always do your own research and consult with qualified financial advisors.
            </div>
        </div>

        <div class="controls">
            <div class="control-group">
                <label for="coinSelect">Cryptocurrency:</label>
                <select id="coinSelect">
                    <option value="bitcoin">Bitcoin (BTC)</option>
                    <option value="ethereum">Ethereum (ETH)</option>
                    <option value="litecoin">Litecoin (LTC)</option>
                    <option value="dogecoin">Dogecoin (DOGE)</option>
                </select>
            </div>
            
            <div class="control-group">
                <label for="timeframe">Timeframe:</label>
                <select id="timeframe">
                    <option value="7">7 Days</option>
                    <option value="14">14 Days</option>
                    <option value="30">30 Days</option>
                </select>
            </div>
            
            <div class="button-group">
                <button onclick="analyzeTA()">üîç Analyze</button>
                <button id="aiExplainBtn" onclick="getAIExplanation()" style="display: none;">ü§ñ AI Explain This</button>
                <button onclick="location.href='../index.html'">üè† Back to Dashboard</button>
            </div>
        </div>

        <div class="grid">
            <div class="chart-container">
                <h3>üìà Price Chart with Technical Indicators</h3>
                <div style="background: #e7f3ff; padding: 10px; border-radius: 8px; margin: 10px 0; font-size: 0.85em; color: #1565c0; border-left: 4px solid #2196f3;">
                    <strong>‚ÑπÔ∏è Chart Information:</strong> Technical indicators (SMA, Bollinger Bands) start after collecting sufficient data points for accurate calculations. This delayed start is mathematically correct and ensures reliable signals.
                    <br><strong>ü§ñ AI Enhancement:</strong> Advanced AI analysis will automatically classify market mood and provide pattern explanations below the chart.
                </div>
                <div id="loading" class="loading">Click "Analyze" to load technical analysis...</div>
                <div class="chart-wrapper">
                    <canvas id="taChart" style="display: none;"></canvas>
                </div>
            </div>

            <div class="indicators-panel">
                <h3>üìä Technical Indicators</h3>
                <div id="indicators">
                    <div class="loading">Analysis results will appear here...</div>
                </div>
            </div>
        </div>

        <!-- AI-Powered Analysis Section -->
        <div id="aiAnalysisSection" style="display: none;">
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 15px; margin-bottom: 20px;">
                <h3 style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                    ü§ñ AI-Powered Market Analysis
                    <span id="aiMethodBadge" style="background: rgba(255,255,255,0.3); padding: 4px 8px; border-radius: 12px; font-size: 0.7em;"></span>
                </h3>
                
                <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 20px; align-items: center;">
                    <div>
                        <div style="text-align: center;">
                            <div id="aiMoodIcon" style="font-size: 3em; margin-bottom: 10px;">ü§ñ</div>
                            <div id="aiMoodLabel" style="font-size: 1.5em; font-weight: 700; margin-bottom: 5px;">Analyzing...</div>
                            <div id="aiConfidence" style="font-size: 0.9em; opacity: 0.9;">Confidence: --</div>
                        </div>
                    </div>
                    
                    <div>
                        <div id="aiReasoning" style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px; font-size: 0.9em; line-height: 1.4;">
                            Generating AI analysis...
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- AI Explanation Section -->
            <div id="aiExplanationSection" style="display: none; background: white; border-radius: 15px; padding: 20px; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); border: 1px solid #e0e0e0; margin-bottom: 20px;">
                <h3 style="color: #2c3e50; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                    üß† AI Pattern Explanation
                    <span id="explainMethodBadge" style="background: #e3f2fd; color: #1565c0; padding: 4px 8px; border-radius: 12px; font-size: 0.7em;"></span>
                </h3>
                <div id="aiExplanationContent" style="background: #f8f9fa; padding: 15px; border-radius: 10px; border-left: 4px solid #667eea; line-height: 1.6;">
                    Click "AI Explain This" to get a detailed explanation of the current market pattern.
                </div>
            </div>
        </div>

        <div id="taSummary" style="display: none;"></div>
    </div>

    <script>
        // Worker URL - Update this to your deployed worker
        const WORKER_URL = 'https://crypto-mood-dashboard.smah0085.workers.dev';
        
        let chartInstance = null;

        // Technical Analysis Functions
        function calculateSMA(data, period) {
            const sma = [];
            for (let i = period - 1; i < data.length; i++) {
                const sum = data.slice(i - period + 1, i + 1).reduce((a, b) => a + b.y, 0);
                sma.push({
                    x: data[i].x,
                    y: sum / period
                });
            }
            return sma;
        }

        function calculateRSI(data, period = 14) {
            const changes = [];
            for (let i = 1; i < data.length; i++) {
                changes.push(data[i].y - data[i - 1].y);
            }

            let avgGain = 0;
            let avgLoss = 0;

            // Initial average
            for (let i = 0; i < period; i++) {
                if (changes[i] > 0) avgGain += changes[i];
                else avgLoss += Math.abs(changes[i]);
            }
            avgGain /= period;
            avgLoss /= period;

            const rsi = [];
            for (let i = period; i < changes.length; i++) {
                if (changes[i] > 0) {
                    avgGain = (avgGain * (period - 1) + changes[i]) / period;
                    avgLoss = (avgLoss * (period - 1)) / period;
                } else {
                    avgGain = (avgGain * (period - 1)) / period;
                    avgLoss = (avgLoss * (period - 1) + Math.abs(changes[i])) / period;
                }

                const rs = avgGain / avgLoss;
                const rsiValue = 100 - (100 / (1 + rs));
                rsi.push({
                    x: data[i + 1].x,
                    y: rsiValue
                });
            }
            return rsi;
        }

        function calculateBollingerBands(data, period = 20, stdDev = 2) {
            const sma = calculateSMA(data, period);
            const bands = { upper: [], middle: [], lower: [] };
            
            for (let i = 0; i < sma.length; i++) {
                const dataSlice = data.slice(i, i + period);
                const mean = sma[i].y;
                const variance = dataSlice.reduce((sum, point) => sum + Math.pow(point.y - mean, 2), 0) / period;
                const standardDeviation = Math.sqrt(variance);
                
                bands.middle.push(sma[i]);
                bands.upper.push({
                    x: sma[i].x,
                    y: mean + (standardDeviation * stdDev)
                });
                bands.lower.push({
                    x: sma[i].x,
                    y: mean - (standardDeviation * stdDev)
                });
            }
            
            return bands;
        }

        function generateTradingSignals(price, rsi, sma, bb) {
            const signals = [];
            const currentPrice = price[price.length - 1].y;
            
            // ‚úÖ FIX: Robust indicator value extraction with null checks
            const currentRSI = rsi.length > 0 ? rsi[rsi.length - 1].y : null;
            const currentSMA = sma.length > 0 ? sma[sma.length - 1].y : null;
            const currentBBUpper = bb.upper.length > 0 ? bb.upper[bb.upper.length - 1].y : null;
            const currentBBLower = bb.lower.length > 0 ? bb.lower[bb.lower.length - 1].y : null;

            // RSI Signals - only generate if RSI is available
            if (currentRSI !== null) {
                if (currentRSI < 30) {
                    signals.push({ type: 'RSI', signal: 'BUY', strength: 'Strong', reason: `Oversold condition (RSI ${currentRSI.toFixed(1)} < 30)` });
                } else if (currentRSI > 70) {
                    signals.push({ type: 'RSI', signal: 'SELL', strength: 'Strong', reason: `Overbought condition (RSI ${currentRSI.toFixed(1)} > 70)` });
                } else {
                    signals.push({ type: 'RSI', signal: 'NEUTRAL', strength: 'Weak', reason: `RSI ${currentRSI.toFixed(1)} in normal range (30-70)` });
                }
            } else {
                signals.push({ type: 'RSI', signal: 'NEUTRAL', strength: 'Weak', reason: 'RSI calculation pending (need 15+ data points)' });
            }

            // Moving Average Signals - only generate if SMA is available
            if (currentSMA !== null) {
                if (currentPrice > currentSMA * 1.02) {
                    signals.push({ type: 'SMA', signal: 'BUY', strength: 'Medium', reason: `Price $${currentPrice.toLocaleString()} above SMA $${currentSMA.toLocaleString()}` });
                } else if (currentPrice < currentSMA * 0.98) {
                    signals.push({ type: 'SMA', signal: 'SELL', strength: 'Medium', reason: `Price $${currentPrice.toLocaleString()} below SMA $${currentSMA.toLocaleString()}` });
                } else {
                    signals.push({ type: 'SMA', signal: 'NEUTRAL', strength: 'Weak', reason: `Price $${currentPrice.toLocaleString()} near SMA $${currentSMA.toLocaleString()}` });
                }
            } else {
                signals.push({ type: 'SMA', signal: 'NEUTRAL', strength: 'Weak', reason: 'SMA calculation pending (need 20+ data points)' });
            }

            // Bollinger Bands Signals - only generate if BB is available
            if (currentBBUpper !== null && currentBBLower !== null) {
                if (currentPrice < currentBBLower) {
                    signals.push({ type: 'BB', signal: 'BUY', strength: 'Medium', reason: `Price $${currentPrice.toLocaleString()} below lower band $${currentBBLower.toLocaleString()}` });
                } else if (currentPrice > currentBBUpper) {
                    signals.push({ type: 'BB', signal: 'SELL', strength: 'Medium', reason: `Price $${currentPrice.toLocaleString()} above upper band $${currentBBUpper.toLocaleString()}` });
                } else {
                    signals.push({ type: 'BB', signal: 'NEUTRAL', strength: 'Weak', reason: `Price $${currentPrice.toLocaleString()} within bands $${currentBBLower.toLocaleString()}-$${currentBBUpper.toLocaleString()}` });
                }
            } else {
                signals.push({ type: 'BB', signal: 'NEUTRAL', strength: 'Weak', reason: 'Bollinger Bands calculation pending (need 20+ data points)' });
            }

            return signals;
        }

        function calculateOverallSignal(signals) {
            let buyCount = 0;
            let sellCount = 0;
            let totalStrength = 0;

            signals.forEach(signal => {
                const strengthValue = signal.strength === 'Strong' ? 3 : signal.strength === 'Medium' ? 2 : 1;
                totalStrength += strengthValue;

                if (signal.signal === 'BUY') buyCount += strengthValue;
                else if (signal.signal === 'SELL') sellCount += strengthValue;
            });

            const buyPercentage = (buyCount / totalStrength) * 100;
            const sellPercentage = (sellCount / totalStrength) * 100;
            const confidence = Math.max(buyPercentage, sellPercentage);

            if (buyPercentage > 60) return { signal: 'BUY', confidence: confidence.toFixed(1) };
            else if (sellPercentage > 60) return { signal: 'SELL', confidence: confidence.toFixed(1) };
            else return { signal: 'HOLD', confidence: (100 - confidence).toFixed(1) };
        }

        async function fetchPriceData(coinId, days) {
            try {
                const response = await fetch(`${WORKER_URL}/history?coin=${coinId}&days=${days}`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                return data.prices.map(item => ({
                    x: new Date(item.timestamp),
                    y: item.price
                }));
            } catch (error) {
                console.error('Error fetching price data:', error);
                throw error;
            }
        }



        function displayChart(price, sma20, bb) {
            const ctx = document.getElementById('taChart').getContext('2d');
            
            // ‚úÖ CHART FIX: Properly destroy existing chart to prevent memory leaks
            if (chartInstance) {
                chartInstance.destroy();
                chartInstance = null;
            }

            // ‚úÖ CHART FIX: Create new chart with proper sizing constraints
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [
                        {
                            label: 'Price',
                            data: price,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            borderWidth: 3,
                            fill: false,
                            tension: 0.1
                        },
                        {
                            label: 'SMA 20 (starts after 20 data points)',
                            data: sma20,
                            borderColor: '#28a745',
                            borderWidth: 2,
                            fill: false,
                            pointRadius: 0
                        },
                        {
                            label: 'BB Upper (requires SMA calculation)',
                            data: bb.upper,
                            borderColor: '#dc3545',
                            borderWidth: 1,
                            borderDash: [5, 5],
                            fill: false,
                            pointRadius: 0
                        },
                        {
                            label: 'BB Lower (requires SMA calculation)',
                            data: bb.lower,
                            borderColor: '#dc3545',
                            borderWidth: 1,
                            borderDash: [5, 5],
                            fill: false,
                            pointRadius: 0
                        }
                    ]
                },
                options: {
                    // ‚úÖ CHART FIX: Proper responsive behavior without stretching
                    responsive: true,
                    maintainAspectRatio: false,
                    // ‚úÖ CHART FIX: Prevent chart from triggering layout changes
                    resizeDelay: 0,
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'day'
                            }
                        },
                        y: {
                            beginAtZero: false
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Technical Analysis Chart',
                            font: { size: 16 }
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        subtitle: {
                            display: true,
                            text: 'üìù Note: Technical indicators start after sufficient data points are collected for accurate calculation',
                            font: { size: 12 },
                            color: '#666',
                            padding: { bottom: 20 }
                        }
                    },
                    // Chart animations
                    animation: {
                        duration: 400,
                        easing: 'easeInOutQuart'
                    },
                    // ‚úÖ CHART FIX: Ensure chart stays within bounds
                    layout: {
                        padding: {
                            top: 10,
                            bottom: 10,
                            left: 10,
                            right: 10
                        }
                    }
                }
            });

            // ‚úÖ CHART FIX: Show chart only after it's fully rendered
            setTimeout(() => {
                document.getElementById('taChart').style.display = 'block';
            }, 100);
        }

        function displayIndicators(rsi, sma20, signals) {
            // ‚úÖ FIX: Robust RSI value extraction with proper fallbacks
            const currentRSI = rsi.length > 0 ? rsi[rsi.length - 1].y : null;
            const rsiDisplay = currentRSI !== null ? currentRSI.toFixed(2) : 'N/A';
            const rsiStatus = currentRSI !== null ? 'Available' : 'Insufficient data (needs 15+ points)';

            const rsiSignal = signals.find(s => s.type === 'RSI');
            const smaSignal = signals.find(s => s.type === 'SMA');
            const bbSignal = signals.find(s => s.type === 'BB');

            // ‚úÖ FIX: Enhanced display with data validation
            document.getElementById('indicators').innerHTML = `
                <div class="indicator">
                    <h3>üìà RSI (14)</h3>
                    <div class="indicator-value">${rsiDisplay}</div>
                    <div class="signal ${rsiSignal.signal.toLowerCase()}">${rsiSignal.signal}</div>
                    <div class="signal-strength">${rsiSignal.strength} Signal</div>
                    <div class="explanation">${rsiSignal.reason}</div>
                    ${currentRSI === null ? `<div style="font-size: 0.8em; color: #ff6b6b; margin-top: 5px;">‚ö†Ô∏è ${rsiStatus}</div>` : ''}
                </div>

                <div class="indicator">
                    <h3>üìä Moving Average (20)</h3>
                    <div class="signal ${smaSignal.signal.toLowerCase()}">${smaSignal.signal}</div>
                    <div class="signal-strength">${smaSignal.strength} Signal</div>
                    <div class="explanation">${smaSignal.reason}</div>
                </div>

                <div class="indicator">
                    <h3>üìè Bollinger Bands</h3>
                    <div class="signal ${bbSignal.signal.toLowerCase()}">${bbSignal.signal}</div>
                    <div class="signal-strength">${bbSignal.strength} Signal</div>
                    <div class="explanation">${bbSignal.reason}</div>
                </div>

                <div style="margin-top: 20px; padding: 15px; background: #f0f8ff; border-radius: 10px; font-size: 0.9em;">
                    <strong>üìö Educational Notes:</strong><br>
                    ‚Ä¢ <strong>Why indicators start mid-chart:</strong> SMA(20) requires 20 data points, BB bands require SMA calculation<br>
                    ‚Ä¢ <strong>RSI interpretation:</strong> < 30 potentially oversold, > 70 potentially overbought<br>
                    ‚Ä¢ <strong>SMA signals:</strong> Price above SMA suggests potential uptrend<br>
                    ‚Ä¢ <strong>Bollinger Bands:</strong> Price touching bands may indicate reversal opportunities<br>
                    ‚Ä¢ <strong>Technical accuracy:</strong> Delayed indicator start ensures mathematical correctness
                </div>
            `;
        }

        function displaySummary(overallSignal, totalSignals, coin) {
            const signalClass = overallSignal.signal.toLowerCase();
            const emoji = overallSignal.signal === 'BUY' ? 'üöÄ' : overallSignal.signal === 'SELL' ? 'üìâ' : '‚è∏Ô∏è';

            document.getElementById('taSummary').innerHTML = `
                <div class="ta-summary">
                    <h3>üìã Technical Analysis Summary for ${coin}</h3>
                    <div class="overall-signal">${emoji} ${overallSignal.signal}</div>
                    <div class="confidence">Confidence: ${overallSignal.confidence}%</div>
                    <div style="margin-top: 15px; font-size: 0.9em;">
                        Based on ${totalSignals} technical indicators
                    </div>
                    <div style="margin-top: 15px; font-size: 0.85em; opacity: 0.9; border-top: 1px solid rgba(255,255,255,0.3); padding-top: 15px;">
                        <strong>‚ö†Ô∏è Remember:</strong> Technical analysis and AI insights are educational tools, not crystal balls. They help identify trends and patterns, but markets can be unpredictable. Technical indicators may start mid-timeframe due to calculation requirements (e.g., SMA needs 20 data points). AI analysis enhances traditional indicators but should not be solely relied upon. This is educational content only, not investment advice. Always do your own research and never invest more than you can afford to lose.
                    </div>
                </div>
            `;
            
            document.getElementById('taSummary').style.display = 'block';
        }

        // =============================================================================
        // AI-POWERED ANALYSIS FUNCTIONS
        // =============================================================================

        // Global variables to store analysis data for AI processing
        let currentAnalysisData = null;

        /**
         * Perform AI-powered market mood analysis
         * Uses Cohere v2/classify endpoint via worker
         */
        async function performAIAnalysis(priceData, rsi, sma20, bb, signals, coinId) {
            try {
                console.log('ü§ñ Starting AI analysis...');
                
                // ‚úÖ FIX: Extract LIVE current price and indicator values from actual chart data
                const liveCurrentPrice = priceData[priceData.length - 1].y;
                const liveCurrentRSI = rsi.length > 0 ? rsi[rsi.length - 1].y : 50;
                const liveCurrentSMA = sma20.length > 0 ? sma20[sma20.length - 1].y : liveCurrentPrice;
                const liveCurrentBBUpper = bb.upper.length > 0 ? bb.upper[bb.upper.length - 1].y : liveCurrentPrice * 1.05;
                const liveCurrentBBLower = bb.lower.length > 0 ? bb.lower[bb.lower.length - 1].y : liveCurrentPrice * 0.95;
                
                const smaSignal = signals.find(s => s.type === 'SMA')?.signal || 'NEUTRAL';
                const bbSignal = signals.find(s => s.type === 'BB')?.signal || 'NEUTRAL';
                
                console.log(`üìä LIVE Analysis Context: Price=$${liveCurrentPrice.toLocaleString()}, RSI=${liveCurrentRSI.toFixed(1)}, SMA=$${liveCurrentSMA.toLocaleString()}, BB=[$${liveCurrentBBLower.toLocaleString()}-$${liveCurrentBBUpper.toLocaleString()}]`);
                
                // Store LIVE data for potential AI explanation later with actual price context
                currentAnalysisData = {
                    priceData, rsi, sma: sma20, bb, signals, coin: coinId, 
                    timeframe: parseInt(document.getElementById('timeframe').value),
                    currentPrice: liveCurrentPrice,
                    currentRSI: liveCurrentRSI,
                    currentSMA: liveCurrentSMA,
                    currentBBUpper: liveCurrentBBUpper,
                    currentBBLower: liveCurrentBBLower
                };
                
                // Call AI analysis endpoint with LIVE values
                const response = await fetch(`${WORKER_URL}/ai-analysis`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        rsi: liveCurrentRSI,
                        smaSignal: smaSignal,
                        bbSignal: bbSignal,
                        priceData: priceData,
                        coin: coinId
                    }),
                });
                
                if (!response.ok) {
                    throw new Error(`AI Analysis API error: ${response.status}`);
                }
                
                const aiResult = await response.json();
                console.log('ü§ñ AI Analysis result:', aiResult);
                
                // Display AI analysis results
                displayAIAnalysis(aiResult);
                
                // Show the AI Explain button
                document.getElementById('aiExplainBtn').style.display = 'inline-flex';
                
            } catch (error) {
                console.error('‚ùå AI Analysis failed:', error);
                displayAIAnalysisError(error.message);
            }
        }

        /**
         * Display AI analysis results in the UI
         */
        function displayAIAnalysis(aiResult) {
            // Show the AI analysis section
            document.getElementById('aiAnalysisSection').style.display = 'block';
            
            // Update mood icon and label
            const moodIcons = {
                'bullish': 'üöÄ',
                'bearish': 'üêª',
                'neutral': '‚öñÔ∏è'
            };
            
            const moodColors = {
                'bullish': '#28a745',
                'bearish': '#dc3545', 
                'neutral': '#6c757d'
            };
            
            document.getElementById('aiMoodIcon').textContent = moodIcons[aiResult.mood] || 'ü§ñ';
            document.getElementById('aiMoodLabel').textContent = aiResult.mood.toUpperCase();
            document.getElementById('aiMoodLabel').style.color = moodColors[aiResult.mood] || '#fff';
            document.getElementById('aiConfidence').textContent = `Confidence: ${aiResult.confidence}%`;
            
            // Update reasoning
            document.getElementById('aiReasoning').textContent = aiResult.reasoning;
            
            // Update method badge
            const methodText = aiResult.method === 'cohere-classify-api' ? 'Cohere AI' : 'Rule-based';
            document.getElementById('aiMethodBadge').textContent = methodText;
        }

        /**
         * Display AI analysis error
         */
        function displayAIAnalysisError(errorMessage) {
            document.getElementById('aiAnalysisSection').style.display = 'block';
            document.getElementById('aiMoodIcon').textContent = '‚ö†Ô∏è';
            document.getElementById('aiMoodLabel').textContent = 'Analysis Failed';
            document.getElementById('aiMoodLabel').style.color = '#dc3545';
            document.getElementById('aiConfidence').textContent = 'Error occurred';
            document.getElementById('aiReasoning').textContent = `AI analysis temporarily unavailable: ${errorMessage}. Using traditional indicators instead.`;
            document.getElementById('aiMethodBadge').textContent = 'Fallback';
        }

        /**
         * Get AI explanation of current pattern
         * Uses Cohere v2/chat endpoint via worker
         */
        async function getAIExplanation() {
            if (!currentAnalysisData) {
                alert('Please run an analysis first!');
                return;
            }
            
            try {
                console.log('üß† Generating AI explanation...');
                
                // Show loading state
                document.getElementById('aiExplanationSection').style.display = 'block';
                document.getElementById('aiExplanationContent').innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px; color: #666;">
                        <div style="width: 20px; height: 20px; border: 2px solid #667eea; border-top: 2px solid transparent; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                        Generating AI explanation...
                    </div>
                `;
                
                // ‚úÖ FIX: Extract LIVE values from current chart data for most accurate AI explanation
                const latestPriceData = currentAnalysisData.priceData;
                const latestRSIData = currentAnalysisData.rsi;
                const latestSMAData = currentAnalysisData.sma;
                const latestBBData = currentAnalysisData.bb;
                
                // Get the actual LATEST values from the arrays (what's shown on chart)
                const liveCurrentPrice = latestPriceData[latestPriceData.length - 1].y;
                const liveCurrentRSI = latestRSIData.length > 0 ? latestRSIData[latestRSIData.length - 1].y : 50;
                const liveCurrentSMA = latestSMAData.length > 0 ? latestSMAData[latestSMAData.length - 1].y : liveCurrentPrice;
                const liveCurrentBBUpper = latestBBData.upper.length > 0 ? latestBBData.upper[latestBBData.upper.length - 1].y : liveCurrentPrice * 1.05;
                const liveCurrentBBLower = latestBBData.lower.length > 0 ? latestBBData.lower[latestBBData.lower.length - 1].y : liveCurrentPrice * 0.95;
                
                console.log(`üìä LIVE Chart Values - Price: $${liveCurrentPrice.toLocaleString()}, RSI: ${liveCurrentRSI.toFixed(1)}, SMA: $${liveCurrentSMA.toLocaleString()}, BB: [$${liveCurrentBBLower.toLocaleString()}-$${liveCurrentBBUpper.toLocaleString()}]`);
                
                // ‚úÖ FIX: Use LIVE chart values for AI explanation instead of potentially stale stored values
                const explanationData = {
                    rsi: currentAnalysisData.rsi,
                    sma: currentAnalysisData.sma,
                    bb: currentAnalysisData.bb,
                    signals: currentAnalysisData.signals,
                    coin: currentAnalysisData.coin,
                    timeframe: currentAnalysisData.timeframe,
                    priceData: currentAnalysisData.priceData,
                    // Include LIVE price context for accurate AI explanations
                    currentPrice: liveCurrentPrice,
                    currentRSI: liveCurrentRSI,
                    currentSMA: liveCurrentSMA,
                    currentBBUpper: liveCurrentBBUpper,
                    currentBBLower: liveCurrentBBLower
                };
                
                console.log('üìä Sending LIVE AI explanation data:', explanationData);
                
                // Call AI explanation endpoint
                const response = await fetch(`${WORKER_URL}/ai-explain`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(explanationData),
                });
                
                if (!response.ok) {
                    throw new Error(`AI Explanation API error: ${response.status}`);
                }
                
                const aiExplanation = await response.json();
                console.log('üß† AI Explanation result:', aiExplanation);
                
                // Display explanation
                displayAIExplanation(aiExplanation);
                
            } catch (error) {
                console.error('‚ùå AI Explanation failed:', error);
                displayAIExplanationError(error.message);
            }
        }

        /**
         * Display AI explanation results
         */
        function displayAIExplanation(aiExplanation) {
            // Format the explanation with proper line breaks
            const formattedExplanation = aiExplanation.explanation
                .replace(/\n\n/g, '</p><p>')
                .replace(/\n/g, '<br>');
            
            document.getElementById('aiExplanationContent').innerHTML = `<p>${formattedExplanation}</p>`;
            
            // Update method badge
            const methodText = aiExplanation.method === 'cohere-chat-api' ? 'Cohere AI' : 'Rule-based';
            document.getElementById('explainMethodBadge').textContent = methodText;
        }

        /**
         * Display AI explanation error
         */
        function displayAIExplanationError(errorMessage) {
            document.getElementById('aiExplanationContent').innerHTML = `
                <div style="color: #dc3545;">
                    <strong>‚ö†Ô∏è AI Explanation Failed:</strong><br>
                    ${errorMessage}<br><br>
                    <em>Try again in a moment or refer to the technical indicators above for manual analysis.</em>
                </div>
            `;
            document.getElementById('explainMethodBadge').textContent = 'Error';
        }

        // Add CSS animation for loading spinner
        const style = document.createElement('style');
        style.textContent = `
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
            
            @media (max-width: 768px) {
                #aiAnalysisSection > div > div {
                    grid-template-columns: 1fr !important;
                }
                
                #aiExplainBtn {
                    width: 100% !important;
                    margin-bottom: 5px;
                }
            }
        `;
        document.head.appendChild(style);

        // =============================================================================
        // ENHANCED ANALYSIS FUNCTION WITH AI INTEGRATION
        // =============================================================================

        // Enhanced analyzeTA function that includes AI analysis
        async function analyzeTA() {
            const coinId = document.getElementById('coinSelect').value;
            const timeframe = parseInt(document.getElementById('timeframe').value);
            
            // ‚úÖ SCROLL FIX: Prevent any automatic scrolling during analysis
            const currentScrollPosition = window.pageYOffset;
            
            document.getElementById('loading').style.display = 'block';
            document.getElementById('taChart').style.display = 'none';
            document.getElementById('indicators').innerHTML = '<div class="loading">Calculating indicators...</div>';
            document.getElementById('taSummary').style.display = 'none';
            // Hide AI sections initially
            document.getElementById('aiAnalysisSection').style.display = 'none';
            document.getElementById('aiExplainBtn').style.display = 'none';

            try {
                const priceData = await fetchPriceData(coinId, timeframe);
                
                // Calculate indicators
                const sma20 = calculateSMA(priceData, 20);
                const rsi = calculateRSI(priceData);
                const bb = calculateBollingerBands(priceData);
                
                // Generate signals
                const signals = generateTradingSignals(priceData, rsi, sma20, bb);
                const overallSignal = calculateOverallSignal(signals);
                
                // Display traditional analysis
                displayChart(priceData, sma20, bb);
                displayIndicators(rsi, sma20, signals);
                displaySummary(overallSignal, signals.length, coinId.toUpperCase());
                
                // ü§ñ PERFORM AI ANALYSIS
                console.log('ü§ñ Starting AI integration...');
                await performAIAnalysis(priceData, rsi, sma20, bb, signals, coinId);
                
                document.getElementById('loading').style.display = 'none';
                
                // ‚úÖ SCROLL FIX: Restore scroll position to prevent unwanted scrolling
                window.scrollTo(0, currentScrollPosition);
                
            } catch (error) {
                document.getElementById('loading').innerHTML = `<div class="error">Error: ${error.message}</div>`;
                // ‚úÖ SCROLL FIX: Restore scroll position even on error
                window.scrollTo(0, currentScrollPosition);
            }
        }

        // Initialize with Bitcoin analysis
        window.onload = function() {
            // You can uncomment the line below to auto-analyze Bitcoin on page load
            // analyzeTA();
        };
    </script>
</body>
</html> 