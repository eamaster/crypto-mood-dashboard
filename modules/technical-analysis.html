<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç Technical Analysis Module - Crypto Dashboard</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìà</text></svg>">
    <link rel="stylesheet" href="../style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
</head>
<body>
    <header>
        <div class="header-content">
            <h1>üîç Technical Analysis Module</h1>
            <button id="themeToggle" class="theme-toggle">üåô</button>
        </div>
    </header>

    <main>
        <div class="ta-container">
            <div class="ta-header">
                <p class="subtitle">Professional crypto technical indicators and signals</p>
                
                <div class="disclaimer">
                    ‚ö†Ô∏è <strong>IMPORTANT DISCLAIMER:</strong> This is for educational purposes only. Technical analysis is not guaranteed to predict future price movements. Cryptocurrency trading involves significant risk of loss. Never invest more than you can afford to lose. This is NOT financial advice. Always do your own research and consult with qualified financial advisors.
                </div>
            </div>

        <div class="controls">
            <div class="control-group">
                <label for="coinSelect">Cryptocurrency:</label>
                <select id="coinSelect">
                    <option value="bitcoin">Bitcoin (BTC)</option>
                    <option value="ethereum">Ethereum (ETH)</option>
                    <option value="dogecoin">Dogecoin (DOGE)</option>
                    <option value="cardano">Cardano (ADA)</option>
                    <option value="solana">Solana (SOL)</option>
                    <option value="litecoin">Litecoin (LTC)</option>
                    <option value="bitcoin-cash">Bitcoin Cash (BCH)</option>
                    <option value="ripple">Ripple (XRP)</option>
                    <option value="polkadot">Polkadot (DOT)</option>
                    <option value="chainlink">Chainlink (LINK)</option>
                    <option value="stellar">Stellar (XLM)</option>
                    <option value="monero">Monero (XMR)</option>
                    <option value="tezos">Tezos (XTZ)</option>
                    <option value="eos">EOS (EOS)</option>
                    <option value="zcash">Zcash (ZEC)</option>
                    <option value="dash">Dash (DASH)</option>
                </select>
            </div>
            
            <div class="control-group">
                <label for="timeframe">Timeframe:</label>
                <select id="timeframe">
                    <option value="7">7 Days</option>
                    <option value="14">14 Days</option>
                    <option value="30">30 Days</option>
                </select>
            </div>
            
            <div class="button-group">
                <button onclick="analyzeTA()">üîç Analyze</button>
                <button id="aiExplainBtn" onclick="getAIExplanation()" style="display: none;">ü§ñ AI Explain This</button>
                <button onclick="location.href='../index.html'" class="ta-button">üè† Back to Dashboard</button>
            </div>
        </div>

        <div class="grid">
            <div class="chart-container">
                <h3>üìà Price Chart with Technical Indicators</h3>
                <div class="chart-info-box">
                    <strong>‚ÑπÔ∏è Chart Information:</strong> Technical indicators (SMA, Bollinger Bands) start after collecting sufficient data points for accurate calculations. This delayed start is mathematically correct and ensures reliable signals.
                    <br><strong>ü§ñ AI Enhancement:</strong> Advanced AI analysis will automatically classify market mood and provide pattern explanations below the chart.
                </div>
                <div id="loading" class="loading" style="display: none;">Fetching data and calculating indicators...</div>
                <div class="chart-wrapper">
                    <canvas id="taChart"></canvas>
                </div>
                <div id="chartError" class="error" style="display: none;"></div>
            </div>

            <div class="indicators-panel">
                <h3>üìä Technical Indicators</h3>
                <div id="indicators">
                    <div class="loading">Analysis results will appear here...</div>
                </div>
            </div>
        </div>

        <!-- AI-Powered Analysis Section -->
        <div id="aiAnalysisSection" style="display: none;">
            <div class="ai-analysis-card">
                <h3 class="ai-analysis-header">
                    ü§ñ AI-Powered Market Analysis
                    <span id="aiMethodBadge" class="ai-method-badge"></span>
                </h3>
                
                <div class="ai-analysis-grid">
                    <div class="ai-mood-display">
                        <div id="aiMoodIcon" class="ai-mood-icon">ü§ñ</div>
                        <div id="aiMoodLabel" class="ai-mood-label">Analyzing...</div>
                        <div id="aiConfidence" class="ai-confidence">Confidence: --</div>
                    </div>
                    
                    <div class="ai-reasoning-container">
                        <div id="aiReasoning" class="ai-reasoning">
                            Generating AI analysis...
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- AI Explanation Section -->
            <div id="aiExplanationSection" style="display: none;" class="ai-explanation-card">
                <h3 class="ai-explanation-header">
                    üß† AI Pattern Explanation
                    <span id="explainMethodBadge" class="ai-explain-badge"></span>
                </h3>
                <div id="aiExplanationContent" class="ai-explanation-content">
                    Click "AI Explain This" to get a detailed explanation of the current market pattern.
                </div>
            </div>
        </div>

        <div id="taSummary" style="display: none;"></div>
        </div>
    </main>

    <footer>
        <p>Data from Blockchair & <a href="https://newsapi.org/" target="_blank" rel="noopener">NewsAPI.org</a> ‚Ä¢ AI by Cohere ‚Ä¢ Built with Chart.js & Cloudflare Workers</p>
        <p><a href="../index.html">üè† Back to Dashboard</a> ‚Ä¢ <a href="index.html">üì¶ View all modules</a></p>
    </footer>

    <script>
        // Filter out browser extension errors from console
        const originalError = console.error;
        const originalWarn = console.warn;
        
        console.error = function(...args) {
            const message = args.join(' ');
            if (message.includes('runtime.lastError') || 
                message.includes('message port closed') || 
                message.includes('content script') ||
                message.includes('Receiving end does not exist') ||
                message.includes('message channel closed') ||
                message.includes('listener indicated an asynchronous response')) {
                return; // Ignore extension errors
            }
            originalError.apply(console, args);
        };
        
        // Also filter console warnings for extension-related issues
        console.warn = function(...args) {
            const message = args.join(' ');
            if (message.includes('runtime.lastError') || 
                message.includes('extension')) {
                return; // Ignore extension warnings
            }
            originalWarn.apply(console, args);
        };

        // Worker URL - Update this to your deployed worker
        const WORKER_URL = 'https://crypto-mood-dashboard.smah0085.workers.dev';
        
        let chartInstance = null;
        
        // Backup function to force chart display if primary method fails
        function forceChartDisplay() {
            const canvas = document.getElementById('taChart');
            if (canvas && chartInstance) {
                console.log('üîß Forcing chart display as backup...');
                
                // Apply essential styles directly
                canvas.style.display = 'block';
                canvas.style.visibility = 'visible';
                canvas.style.opacity = '1';
                canvas.style.width = '100%';
                canvas.style.height = '420px';
                canvas.style.position = 'relative';
                canvas.style.zIndex = '10';
                canvas.classList.add('visible');
                
                // Force Chart.js to re-render
                chartInstance.update();
                chartInstance.resize();
                chartInstance.render();
                
                console.log('‚úÖ Backup chart display completed');
            }
        }

        // Technical Analysis Functions
        function calculateSMA(data, period) {
            const sma = [];
            for (let i = period - 1; i < data.length; i++) {
                const sum = data.slice(i - period + 1, i + 1).reduce((a, b) => a + b.y, 0);
                sma.push({
                    x: data[i].x,
                    y: sum / period
                });
            }
            return sma;
        }

        function calculateRSI(data, period = 14) {
            const changes = [];
            for (let i = 1; i < data.length; i++) {
                changes.push(data[i].y - data[i - 1].y);
            }

            let avgGain = 0;
            let avgLoss = 0;

            // Initial average
            for (let i = 0; i < period; i++) {
                if (changes[i] > 0) avgGain += changes[i];
                else avgLoss += Math.abs(changes[i]);
            }
            avgGain /= period;
            avgLoss /= period;

            const rsi = [];
            for (let i = period; i < changes.length; i++) {
                if (changes[i] > 0) {
                    avgGain = (avgGain * (period - 1) + changes[i]) / period;
                    avgLoss = (avgLoss * (period - 1)) / period;
                } else {
                    avgGain = (avgGain * (period - 1)) / period;
                    avgLoss = (avgLoss * (period - 1) + Math.abs(changes[i])) / period;
                }

                const rs = avgGain / avgLoss;
                const rsiValue = 100 - (100 / (1 + rs));
                rsi.push({
                    x: data[i + 1].x,
                    y: rsiValue
                });
            }
            return rsi;
        }

        function calculateBollingerBands(data, period = 20, stdDev = 2) {
            const sma = calculateSMA(data, period);
            const bands = { upper: [], middle: [], lower: [] };
            
            for (let i = 0; i < sma.length; i++) {
                const dataSlice = data.slice(i, i + period);
                const mean = sma[i].y;
                const variance = dataSlice.reduce((sum, point) => sum + Math.pow(point.y - mean, 2), 0) / period;
                const standardDeviation = Math.sqrt(variance);
                
                bands.middle.push(sma[i]);
                bands.upper.push({
                    x: sma[i].x,
                    y: mean + (standardDeviation * stdDev)
                });
                bands.lower.push({
                    x: sma[i].x,
                    y: mean - (standardDeviation * stdDev)
                });
            }
            
            return bands;
        }

        function generateTradingSignals(price, rsi, sma, bb) {
            const signals = [];
            const currentPrice = price[price.length - 1].y;
            
            // ‚úÖ FIX: Robust indicator value extraction with null checks
            const currentRSI = rsi.length > 0 ? rsi[rsi.length - 1].y : null;
            const currentSMA = sma.length > 0 ? sma[sma.length - 1].y : null;
            const currentBBUpper = bb.upper.length > 0 ? bb.upper[bb.upper.length - 1].y : null;
            const currentBBLower = bb.lower.length > 0 ? bb.lower[bb.lower.length - 1].y : null;

            // RSI Signals - only generate if RSI is available
            if (currentRSI !== null) {
                if (currentRSI < 30) {
                    signals.push({ type: 'RSI', signal: 'BUY', strength: 'Strong', reason: `Oversold condition (RSI ${currentRSI.toFixed(1)} < 30)` });
                } else if (currentRSI > 70) {
                    signals.push({ type: 'RSI', signal: 'SELL', strength: 'Strong', reason: `Overbought condition (RSI ${currentRSI.toFixed(1)} > 70)` });
                } else {
                    signals.push({ type: 'RSI', signal: 'NEUTRAL', strength: 'Weak', reason: `RSI ${currentRSI.toFixed(1)} in normal range (30-70)` });
                }
            } else {
                signals.push({ type: 'RSI', signal: 'NEUTRAL', strength: 'Weak', reason: 'RSI calculation pending (need 15+ data points)' });
            }

            // Moving Average Signals - only generate if SMA is available
            if (currentSMA !== null) {
                if (currentPrice > currentSMA * 1.02) {
                    signals.push({ type: 'SMA', signal: 'BUY', strength: 'Medium', reason: `Price $${currentPrice.toLocaleString()} above SMA $${currentSMA.toLocaleString()}` });
                } else if (currentPrice < currentSMA * 0.98) {
                    signals.push({ type: 'SMA', signal: 'SELL', strength: 'Medium', reason: `Price $${currentPrice.toLocaleString()} below SMA $${currentSMA.toLocaleString()}` });
                } else {
                    signals.push({ type: 'SMA', signal: 'NEUTRAL', strength: 'Weak', reason: `Price $${currentPrice.toLocaleString()} near SMA $${currentSMA.toLocaleString()}` });
                }
            } else {
                signals.push({ type: 'SMA', signal: 'NEUTRAL', strength: 'Weak', reason: 'SMA calculation pending (need 20+ data points)' });
            }

            // Bollinger Bands Signals - only generate if BB is available
            if (currentBBUpper !== null && currentBBLower !== null) {
                if (currentPrice < currentBBLower) {
                    signals.push({ type: 'BB', signal: 'BUY', strength: 'Medium', reason: `Price $${currentPrice.toLocaleString()} below lower band $${currentBBLower.toLocaleString()}` });
                } else if (currentPrice > currentBBUpper) {
                    signals.push({ type: 'BB', signal: 'SELL', strength: 'Medium', reason: `Price $${currentPrice.toLocaleString()} above upper band $${currentBBUpper.toLocaleString()}` });
                } else {
                    signals.push({ type: 'BB', signal: 'NEUTRAL', strength: 'Weak', reason: `Price $${currentPrice.toLocaleString()} within bands $${currentBBLower.toLocaleString()}-$${currentBBUpper.toLocaleString()}` });
                }
            } else {
                signals.push({ type: 'BB', signal: 'NEUTRAL', strength: 'Weak', reason: 'Bollinger Bands calculation pending (need 20+ data points)' });
            }

            return signals;
        }

        function calculateOverallSignal(signals) {
            let buyCount = 0;
            let sellCount = 0;
            let totalStrength = 0;

            signals.forEach(signal => {
                const strengthValue = signal.strength === 'Strong' ? 3 : signal.strength === 'Medium' ? 2 : 1;
                totalStrength += strengthValue;

                if (signal.signal === 'BUY') buyCount += strengthValue;
                else if (signal.signal === 'SELL') sellCount += strengthValue;
            });

            const buyPercentage = (buyCount / totalStrength) * 100;
            const sellPercentage = (sellCount / totalStrength) * 100;
            const confidence = Math.max(buyPercentage, sellPercentage);

            if (buyPercentage > 60) return { signal: 'BUY', confidence: confidence.toFixed(1) };
            else if (sellPercentage > 60) return { signal: 'SELL', confidence: confidence.toFixed(1) };
            else return { signal: 'HOLD', confidence: (100 - confidence).toFixed(1) };
        }

        async function fetchPriceData(coinId, days) {
            try {
                console.log(`Fetching price data for ${coinId} over ${days} days...`);
                const response = await fetch(`${WORKER_URL}/history?coin=${coinId}&days=${days}`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                console.log(`Received ${data.prices.length} price points`);
                
                const priceData = data.prices.map(item => ({
                    x: new Date(item.timestamp),
                    y: item.price
                }));
                
                // Ensure we have enough data for technical analysis
                if (priceData.length < 20) {
                    throw new Error(`Insufficient data: only ${priceData.length} points available (need at least 20 for technical indicators)`);
                }
                
                return priceData;
            } catch (error) {
                console.error('Error fetching price data:', error);
                throw error;
            }
        }

        function displayChart(price, sma20, bb) {
            console.log('Creating chart with data:', {
                pricePoints: price.length,
                smaPoints: sma20.length,
                bbUpperPoints: bb.upper.length,
                bbLowerPoints: bb.lower.length
            });
            
            const canvas = document.getElementById('taChart');
            const ctx = canvas.getContext('2d');
            
            // Reset canvas visibility
            canvas.style.display = 'none';
            canvas.classList.remove('visible');
            
            // ‚úÖ CHART FIX: Properly destroy existing chart to prevent memory leaks
            if (chartInstance) {
                chartInstance.destroy();
                chartInstance = null;
            }

            // üõ†Ô∏è FIX: Enhanced theme-aware colors with better contrast
            const isDark = document.body.classList.contains('dark-theme');
            const priceColor = getComputedStyle(document.documentElement).getPropertyValue('--accent-color').trim() || '#3B82F6';
            const successColor = getComputedStyle(document.documentElement).getPropertyValue('--success-color').trim() || '#10B981';
            const dangerColor = getComputedStyle(document.documentElement).getPropertyValue('--danger-color').trim() || '#EF4444';
            const warningColor = getComputedStyle(document.documentElement).getPropertyValue('--warning-color').trim() || '#F59E0B';
            
            // üõ†Ô∏è FIX: Better contrast colors for both light and dark themes
            const textColor = isDark ? '#ffffff' : '#1a202c';
            const gridColor = isDark ? 'rgba(255, 255, 255, 0.15)' : 'rgba(0, 0, 0, 0.1)';
            const backgroundColor = isDark ? 'rgba(30, 41, 59, 0.8)' : 'rgba(255, 255, 255, 0.95)';
            const borderColor = isDark ? 'rgba(255, 255, 255, 0.2)' : 'rgba(0, 0, 0, 0.1)';
            
            console.log('üé® Theme colors applied:', { isDark, textColor, gridColor, backgroundColor });

            // Prepare datasets for chart
            const datasets = [
                {
                    label: 'Price',
                    data: price,
                    borderColor: priceColor,
                    backgroundColor: priceColor + '20',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.1,
                    pointRadius: 1,
                    pointHoverRadius: 5,
                    order: 1
                }
            ];

            // Add SMA if available
            if (sma20.length > 0) {
                datasets.push({
                    label: `SMA 20 (${sma20.length} points)`,
                    data: sma20,
                    borderColor: successColor,
                    borderWidth: 2,
                    fill: false,
                    pointRadius: 0,
                    pointHoverRadius: 3,
                    order: 2
                });
            }

            // Add Bollinger Bands if available
            if (bb.upper.length > 0 && bb.lower.length > 0) {
                datasets.push(
                    {
                        label: `BB Upper (${bb.upper.length} points)`,
                        data: bb.upper,
                        borderColor: dangerColor,
                        borderWidth: 1,
                        borderDash: [5, 5],
                        fill: false,
                        pointRadius: 0,
                        order: 3
                    },
                    {
                        label: `BB Lower (${bb.lower.length} points)`,
                        data: bb.lower,
                        borderColor: dangerColor,
                        borderWidth: 1,
                        borderDash: [5, 5],
                        fill: false,
                        pointRadius: 0,
                        order: 4
                    }
                );
            }

            console.log('Chart datasets prepared:', datasets.map(d => ({ label: d.label, dataPoints: d.data.length })));

            // üõ†Ô∏è FIX: Enhanced Chart.js configuration with improved theme consistency
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: { datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    resizeDelay: 0,
                    devicePixelRatio: window.devicePixelRatio || 1,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: { unit: 'day' },
                            ticks: {
                                maxTicksLimit: window.innerWidth < 768 ? 4 : 7,
                                font: {
                                    size: window.innerWidth < 768 ? 10 : 11,
                                    weight: '500',
                                    family: 'system-ui, -apple-system, sans-serif'
                                },
                                color: textColor,
                                padding: 2
                            },
                            grid: {
                                color: gridColor,
                                lineWidth: 1
                            },
                            border: {
                                color: borderColor,
                                width: 1
                            },
                            title: {
                                display: true,
                                text: 'Date',
                                color: textColor,
                                font: {
                                    size: window.innerWidth < 768 ? 11 : 12,
                                    weight: '600',
                                    family: 'system-ui, -apple-system, sans-serif'
                                },
                                padding: { top: 2, bottom: 2 }
                            }
                        },
                        y: {
                            beginAtZero: false,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                },
                                font: {
                                    size: window.innerWidth < 768 ? 10 : 11,
                                    weight: '500',
                                    family: 'system-ui, -apple-system, sans-serif'
                                },
                                color: textColor,
                                padding: 2
                            },
                            grid: {
                                color: gridColor,
                                lineWidth: 1
                            },
                            border: {
                                color: borderColor,
                                width: 1
                            },
                            title: {
                                display: true,
                                text: 'Price (USD)',
                                color: textColor,
                                font: {
                                    size: window.innerWidth < 768 ? 11 : 12,
                                    weight: '600',
                                    family: 'system-ui, -apple-system, sans-serif'
                                },
                                padding: { top: 2, bottom: 2 }
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'üìà Technical Analysis Chart',
                            font: { 
                                size: window.innerWidth < 768 ? 13 : 15,
                                weight: 'bold',
                                family: 'system-ui, -apple-system, sans-serif'
                            },
                            color: textColor,
                            padding: { top: 4, bottom: 6 }
                        },
                        legend: {
                            display: true,
                            position: window.innerWidth < 768 ? 'bottom' : 'top',
                            labels: {
                                font: {
                                    size: window.innerWidth < 768 ? 10 : 11,
                                    weight: '500',
                                    family: 'system-ui, -apple-system, sans-serif'
                                },
                                padding: 8,
                                usePointStyle: true,
                                boxWidth: window.innerWidth < 768 ? 8 : 10,
                                color: textColor
                            }
                        },
                        subtitle: {
                            display: window.innerWidth >= 768,
                            text: 'üìù Note: Technical indicators start after sufficient data points are collected for accurate calculation',
                            font: { 
                                size: 10,
                                style: 'italic',
                                weight: '400',
                                family: 'system-ui, -apple-system, sans-serif'
                            },
                            color: textColor,
                            padding: { top: 2, bottom: 6 }
                        },
                        tooltip: {
                            backgroundColor: backgroundColor,
                            titleColor: textColor,
                            bodyColor: textColor,
                            borderColor: borderColor,
                            borderWidth: 1,
                            cornerRadius: 6,
                            titleFont: { 
                                size: window.innerWidth < 768 ? 11 : 12,
                                weight: '600',
                                family: 'system-ui, -apple-system, sans-serif'
                            },
                            bodyFont: { 
                                size: window.innerWidth < 768 ? 10 : 11,
                                weight: '500',
                                family: 'system-ui, -apple-system, sans-serif'
                            },
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += '$' + context.parsed.y.toLocaleString();
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    layout: {
                        padding: { top: 2, bottom: 2, left: 2, right: 2 }
                    },
                    animation: {
                        duration: window.innerWidth < 768 ? 100 : 200,
                        easing: 'easeInOutQuart'
                    },
                    elements: {
                        point: {
                            radius: window.innerWidth < 768 ? 1 : 2,
                            hoverRadius: window.innerWidth < 768 ? 3 : 4,
                            borderWidth: window.innerWidth < 768 ? 1 : 1
                        },
                        line: {
                            tension: 0.1,
                            borderWidth: window.innerWidth < 768 ? 1 : 2
                        }
                    }
                }
            });

            // üîß FIXED: Reliable chart display with proper timing
            setTimeout(() => {
                const canvas = document.getElementById('taChart');
                
                // Simple, reliable canvas visibility
                canvas.style.display = 'block';
                canvas.style.visibility = 'visible';
                canvas.style.opacity = '1';
                canvas.classList.add('visible');
                
                // Ensure chart renders properly
                if (chartInstance) {
                    chartInstance.update();
                    chartInstance.resize();
                    
                    // Final render after a short delay
                    setTimeout(() => {
                        chartInstance.render();
                        console.log('‚úÖ Chart successfully rendered:', {
                            canvasWidth: canvas.clientWidth,
                            canvasHeight: canvas.clientHeight,
                            hasChart: !!chartInstance,
                            datasetsCount: chartInstance.data.datasets.length
                        });
                    }, 50);
                }
            }, 100);
        }

        function displayIndicators(rsi, sma20, signals) {
            // ‚úÖ FIX: Robust RSI value extraction with proper fallbacks
            const currentRSI = rsi.length > 0 ? rsi[rsi.length - 1].y : null;
            const rsiDisplay = currentRSI !== null ? currentRSI.toFixed(2) : 'N/A';
            const rsiStatus = currentRSI !== null ? 'Available' : 'Insufficient data (needs 15+ points)';

            const rsiSignal = signals.find(s => s.type === 'RSI');
            const smaSignal = signals.find(s => s.type === 'SMA');
            const bbSignal = signals.find(s => s.type === 'BB');

            // ‚úÖ FIX: Enhanced display with data validation
            document.getElementById('indicators').innerHTML = `
                <div class="indicator">
                    <h3>üìà RSI (14)</h3>
                    <div class="indicator-value">${rsiDisplay}</div>
                    <div class="signal ${rsiSignal.signal.toLowerCase()}">${rsiSignal.signal}</div>
                    <div class="signal-strength">${rsiSignal.strength} Signal</div>
                    <div class="explanation">${rsiSignal.reason}</div>
                    ${currentRSI === null ? `<div style="font-size: 0.8em; color: var(--warning-color); margin-top: 5px;">‚ö†Ô∏è ${rsiStatus}</div>` : ''}
                </div>

                <div class="indicator">
                    <h3>üìä Moving Average (20)</h3>
                    <div class="signal ${smaSignal.signal.toLowerCase()}">${smaSignal.signal}</div>
                    <div class="signal-strength">${smaSignal.strength} Signal</div>
                    <div class="explanation">${smaSignal.reason}</div>
                </div>

                <div class="indicator">
                    <h3>üìè Bollinger Bands</h3>
                    <div class="signal ${bbSignal.signal.toLowerCase()}">${bbSignal.signal}</div>
                    <div class="signal-strength">${bbSignal.strength} Signal</div>
                    <div class="explanation">${bbSignal.reason}</div>
                </div>

                <div class="educational-notes">
                    <strong>üìö Educational Notes:</strong><br>
                    ‚Ä¢ <strong>Why indicators start mid-chart:</strong> SMA(20) requires 20 data points, BB bands require SMA calculation<br>
                    ‚Ä¢ <strong>RSI interpretation:</strong> < 30 potentially oversold, > 70 potentially overbought<br>
                    ‚Ä¢ <strong>SMA signals:</strong> Price above SMA suggests potential uptrend<br>
                    ‚Ä¢ <strong>Bollinger Bands:</strong> Price touching bands may indicate reversal opportunities<br>
                    ‚Ä¢ <strong>Technical accuracy:</strong> Delayed indicator start ensures mathematical correctness
                </div>
            `;
        }

        function displaySummary(overallSignal, totalSignals, coin) {
            const signalClass = overallSignal.signal.toLowerCase();
            const emoji = overallSignal.signal === 'BUY' ? 'üöÄ' : overallSignal.signal === 'SELL' ? 'üìâ' : '‚è∏Ô∏è';

            document.getElementById('taSummary').innerHTML = `
                <div class="ta-summary">
                    <h3>üìã Technical Analysis Summary for ${coin}</h3>
                    <div class="overall-signal">${emoji} ${overallSignal.signal}</div>
                    <div class="confidence">Confidence: ${overallSignal.confidence}%</div>
                    <div style="margin-top: 15px; font-size: 0.9em;">
                        Based on ${totalSignals} technical indicators
                    </div>
                    <div style="margin-top: 15px; font-size: 0.85em; opacity: 0.9; border-top: 1px solid rgba(255,255,255,0.3); padding-top: 15px;">
                        <strong>‚ö†Ô∏è Remember:</strong> Technical analysis and AI insights are educational tools, not crystal balls. They help identify trends and patterns, but markets can be unpredictable. Technical indicators may start mid-timeframe due to calculation requirements (e.g., SMA needs 20 data points). AI analysis enhances traditional indicators but should not be solely relied upon. This is educational content only, not investment advice. Always do your own research and never invest more than you can afford to lose.
                    </div>
                </div>
            `;
            
            document.getElementById('taSummary').style.display = 'block';
        }

        // =============================================================================
        // AI-POWERED ANALYSIS FUNCTIONS
        // =============================================================================

        // Global variables to store analysis data for AI processing
        let currentAnalysisData = null;

        /**
         * Perform AI-powered market mood analysis
         * Uses Cohere v2/classify endpoint via worker
         */
        async function performAIAnalysis(priceData, rsi, sma20, bb, signals, coinId) {
            try {
                console.log('ü§ñ Starting AI analysis...');
                
                // ‚úÖ FIX: Extract LIVE current price and indicator values from actual chart data
                const liveCurrentPrice = priceData[priceData.length - 1].y;
                const liveCurrentRSI = rsi.length > 0 ? rsi[rsi.length - 1].y : 50;
                const liveCurrentSMA = sma20.length > 0 ? sma20[sma20.length - 1].y : liveCurrentPrice;
                const liveCurrentBBUpper = bb.upper.length > 0 ? bb.upper[bb.upper.length - 1].y : liveCurrentPrice * 1.05;
                const liveCurrentBBLower = bb.lower.length > 0 ? bb.lower[bb.lower.length - 1].y : liveCurrentPrice * 0.95;
                
                const smaSignal = signals.find(s => s.type === 'SMA')?.signal || 'NEUTRAL';
                const bbSignal = signals.find(s => s.type === 'BB')?.signal || 'NEUTRAL';
                
                console.log(`üìä LIVE Analysis Context: Price=$${liveCurrentPrice.toLocaleString()}, RSI=${liveCurrentRSI.toFixed(1)}, SMA=$${liveCurrentSMA.toLocaleString()}, BB=[$${liveCurrentBBLower.toLocaleString()}-$${liveCurrentBBUpper.toLocaleString()}]`);
                
                // Store LIVE data for potential AI explanation later with actual price context
                currentAnalysisData = {
                    priceData, rsi, sma: sma20, bb, signals, coin: coinId, 
                    timeframe: parseInt(document.getElementById('timeframe').value),
                    currentPrice: liveCurrentPrice,
                    currentRSI: liveCurrentRSI,
                    currentSMA: liveCurrentSMA,
                    currentBBUpper: liveCurrentBBUpper,
                    currentBBLower: liveCurrentBBLower
                };
                
                // Call AI analysis endpoint with LIVE values
                const response = await fetch(`${WORKER_URL}/ai-analysis`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        rsi: liveCurrentRSI,
                        smaSignal: smaSignal,
                        bbSignal: bbSignal,
                        priceData: priceData,
                        coin: coinId
                    }),
                });
                
                if (!response.ok) {
                    throw new Error(`AI Analysis API error: ${response.status}`);
                }
                
                const aiResult = await response.json();
                console.log('ü§ñ AI Analysis result:', aiResult);
                
                // Display AI analysis results
                displayAIAnalysis(aiResult);
                
                // Show the AI Explain button
                document.getElementById('aiExplainBtn').style.display = 'inline-flex';
                
            } catch (error) {
                console.error('‚ùå AI Analysis failed:', error);
                displayAIAnalysisError(error.message);
            }
        }

        /**
         * Display AI analysis results in the UI
         */
        function displayAIAnalysis(aiResult) {
            // Show the AI analysis section
            document.getElementById('aiAnalysisSection').style.display = 'block';
            
            // Update mood icon and label
            const moodIcons = {
                'bullish': 'üöÄ',
                'bearish': 'üêª',
                'neutral': '‚öñÔ∏è'
            };
            
            const aiMoodLabel = document.getElementById('aiMoodLabel');
            const aiMoodIcon = document.getElementById('aiMoodIcon');
            
            // Set icon and text
            aiMoodIcon.textContent = moodIcons[aiResult.mood] || 'ü§ñ';
            aiMoodLabel.textContent = aiResult.mood.toUpperCase();
            
            // ‚úÖ FIX: Apply proper styling classes for better contrast
            aiMoodLabel.className = ''; // Clear existing classes
            aiMoodLabel.classList.add(aiResult.mood); // Add mood-specific class
            
            // Enhanced contrast for different moods
            if (aiResult.mood === 'neutral') {
                // White text with dark background for better contrast on purple
                aiMoodLabel.style.color = '#ffffff';
                aiMoodLabel.style.background = 'rgba(255,255,255,0.25)';
                aiMoodLabel.style.border = '2px solid rgba(255,255,255,0.4)';
                aiMoodLabel.style.padding = '8px 16px';
                aiMoodLabel.style.borderRadius = '8px';
                aiMoodLabel.style.textShadow = '2px 2px 4px rgba(0,0,0,0.8)';
                aiMoodLabel.style.fontWeight = '800';
            } else if (aiResult.mood === 'bullish') {
                aiMoodLabel.style.color = '#4ade80';
                aiMoodLabel.style.textShadow = '2px 2px 4px rgba(0,0,0,0.8)';
                aiMoodLabel.style.fontWeight = '800';
            } else if (aiResult.mood === 'bearish') {
                aiMoodLabel.style.color = '#f87171';
                aiMoodLabel.style.textShadow = '2px 2px 4px rgba(0,0,0,0.8)';
                aiMoodLabel.style.fontWeight = '800';
            }
            
            // Enhanced confidence styling
            const aiConfidence = document.getElementById('aiConfidence');
            aiConfidence.textContent = `Confidence: ${aiResult.confidence}%`;
            aiConfidence.style.color = '#ffffff';
            aiConfidence.style.fontWeight = '600';
            aiConfidence.style.textShadow = '1px 1px 2px rgba(0,0,0,0.6)';
            
            // Update reasoning
            document.getElementById('aiReasoning').textContent = aiResult.reasoning;
            
            // Update method badge
            const methodText = aiResult.method === 'cohere-classify-api' ? 'Cohere AI' : 'Rule-based';
            document.getElementById('aiMethodBadge').textContent = methodText;
        }

        /**
         * Display AI analysis error
         */
        function displayAIAnalysisError(errorMessage) {
            document.getElementById('aiAnalysisSection').style.display = 'block';
            document.getElementById('aiMoodIcon').textContent = '‚ö†Ô∏è';
            document.getElementById('aiMoodLabel').textContent = 'Analysis Failed';
            document.getElementById('aiMoodLabel').style.color = 'var(--danger-color)';
            document.getElementById('aiConfidence').textContent = 'Error occurred';
            document.getElementById('aiReasoning').textContent = `AI analysis temporarily unavailable: ${errorMessage}. Using traditional indicators instead.`;
            document.getElementById('aiMethodBadge').textContent = 'Fallback';
        }

        /**
         * Get AI explanation of current pattern
         * Uses Cohere v2/chat endpoint via worker
         */
        async function getAIExplanation() {
            if (!currentAnalysisData) {
                alert('Please run an analysis first!');
                return;
            }
            
            try {
                console.log('üß† Generating AI explanation...');
                
                // Show loading state
                document.getElementById('aiExplanationSection').style.display = 'block';
                document.getElementById('aiExplanationContent').innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px; color: var(--text-secondary);">
                        <div class="loading-spinner"></div>
                        Generating AI explanation...
                    </div>
                `;
                
                // ‚úÖ FIX: Extract LIVE values from current chart data for most accurate AI explanation
                const latestPriceData = currentAnalysisData.priceData;
                const latestRSIData = currentAnalysisData.rsi;
                const latestSMAData = currentAnalysisData.sma;
                const latestBBData = currentAnalysisData.bb;
                
                // Get the actual LATEST values from the arrays (what's shown on chart)
                const liveCurrentPrice = latestPriceData[latestPriceData.length - 1].y;
                const liveCurrentRSI = latestRSIData.length > 0 ? latestRSIData[latestRSIData.length - 1].y : 50;
                const liveCurrentSMA = latestSMAData.length > 0 ? latestSMAData[latestSMAData.length - 1].y : liveCurrentPrice;
                const liveCurrentBBUpper = latestBBData.upper.length > 0 ? latestBBData.upper[latestBBData.upper.length - 1].y : liveCurrentPrice * 1.05;
                const liveCurrentBBLower = latestBBData.lower.length > 0 ? latestBBData.lower[latestBBData.lower.length - 1].y : liveCurrentPrice * 0.95;
                
                console.log(`üìä LIVE Chart Values - Price: $${liveCurrentPrice.toLocaleString()}, RSI: ${liveCurrentRSI.toFixed(1)}, SMA: $${liveCurrentSMA.toLocaleString()}, BB: [$${liveCurrentBBLower.toLocaleString()}-$${liveCurrentBBUpper.toLocaleString()}]`);
                
                // ‚úÖ FIX: Use LIVE chart values for AI explanation instead of potentially stale stored values
                const explanationData = {
                    rsi: currentAnalysisData.rsi,
                    sma: currentAnalysisData.sma,
                    bb: currentAnalysisData.bb,
                    signals: currentAnalysisData.signals,
                    coin: currentAnalysisData.coin,
                    timeframe: currentAnalysisData.timeframe,
                    priceData: currentAnalysisData.priceData,
                    // Include LIVE price context for accurate AI explanations
                    currentPrice: liveCurrentPrice,
                    currentRSI: liveCurrentRSI,
                    currentSMA: liveCurrentSMA,
                    currentBBUpper: liveCurrentBBUpper,
                    currentBBLower: liveCurrentBBLower
                };
                
                console.log('üìä Sending LIVE AI explanation data:', explanationData);
                
                // Call AI explanation endpoint
                const response = await fetch(`${WORKER_URL}/ai-explain`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(explanationData),
                });
                
                if (!response.ok) {
                    throw new Error(`AI Explanation API error: ${response.status}`);
                }
                
                const aiExplanation = await response.json();
                console.log('üß† AI Explanation result:', aiExplanation);
                
                // Display explanation
                displayAIExplanation(aiExplanation);
                
            } catch (error) {
                console.error('‚ùå AI Explanation failed:', error);
                displayAIExplanationError(error.message);
            }
        }

        /**
         * Display AI explanation results
         */
        function displayAIExplanation(aiExplanation) {
            // Format the explanation with proper line breaks
            const formattedExplanation = aiExplanation.explanation
                .replace(/\n\n/g, '</p><p>')
                .replace(/\n/g, '<br>');
            
            document.getElementById('aiExplanationContent').innerHTML = `<p>${formattedExplanation}</p>`;
            
            // Update method badge
            const methodText = aiExplanation.method === 'cohere-chat-api' ? 'Cohere AI' : 'Rule-based';
            document.getElementById('explainMethodBadge').textContent = methodText;
        }

        /**
         * Display AI explanation error
         */
        function displayAIExplanationError(errorMessage) {
            document.getElementById('aiExplanationContent').innerHTML = `
                <div style="color: var(--danger-color);">
                    <strong>‚ö†Ô∏è AI Explanation Failed:</strong><br>
                    ${errorMessage}<br><br>
                    <em>Try again in a moment or refer to the technical indicators above for manual analysis.</em>
                </div>
            `;
            document.getElementById('explainMethodBadge').textContent = 'Error';
        }

        // Add CSS animation for loading spinner and mobile optimizations
        const style = document.createElement('style');
        style.textContent = `
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
            
            @keyframes fadeIn {
                0% { opacity: 0; transform: translateY(10px); }
                100% { opacity: 1; transform: translateY(0); }
            }
            
            .loading-spinner {
                width: 20px;
                height: 20px;
                border: 2px solid var(--border-color);
                border-top: 2px solid var(--accent-color);
                border-radius: 50%;
                animation: spin 1s linear infinite;
            }
            
            /* üõ†Ô∏è FIX: Mobile-specific AI section improvements with enhanced theme support */
            @media (max-width: 768px) {
                #aiAnalysisSection > div > div {
                    grid-template-columns: 1fr !important;
                }
                
                #aiExplainBtn {
                    width: 100% !important;
                    margin-bottom: 5px;
                }
                
                /* Smooth animations for mobile */
                .indicator {
                    animation: fadeIn 0.3s ease-out;
                }
                
                /* Better chart container on mobile */
                .chart-container h3 {
                    font-size: 1.1em;
                    margin-bottom: 10px;
                }
                
                /* Improved loading state with better contrast */
                .loading {
                    padding: 20px;
                    font-size: 0.9em;
                    color: var(--text-primary);
                    background: var(--bg-secondary);
                    border-radius: 8px;
                    border: 1px solid var(--border-color);
                }
                
                /* Enhanced error state for mobile */
                .error {
                    font-size: 0.85em;
                    padding: 1rem;
                    border-radius: 8px;
                }
            }
            
            /* Accessibility improvements */
            @media (prefers-reduced-motion: reduce) {
                .loading-spinner {
                    animation: none !important;
                }
                * {
                    animation-duration: 0.01ms !important;
                    animation-iteration-count: 1 !important;
                    transition-duration: 0.01ms !important;
                }
            }
        `;
        document.head.appendChild(style);

        // =============================================================================
        // ENHANCED ANALYSIS FUNCTION WITH AI INTEGRATION
        // =============================================================================

        // Enhanced analyzeTA function that includes AI analysis
        async function analyzeTA() {
            const coinId = document.getElementById('coinSelect').value;
            const timeframe = parseInt(document.getElementById('timeframe').value);
            
            // üîß FIXED: Destroy test chart if it exists
            if (window.testChartInstance) {
                window.testChartInstance.destroy();
                window.testChartInstance = null;
                console.log('üß™ Test chart destroyed, starting real analysis...');
            }
            
            // ‚úÖ SCROLL FIX: Prevent any automatic scrolling during analysis
            const currentScrollPosition = window.pageYOffset;
            
            document.getElementById('loading').style.display = 'block';
            document.getElementById('taChart').style.display = 'none';
            document.getElementById('indicators').innerHTML = '<div class="loading">Calculating indicators...</div>';
            document.getElementById('taSummary').style.display = 'none';
            // Hide AI sections initially
            document.getElementById('aiAnalysisSection').style.display = 'none';
            document.getElementById('aiExplainBtn').style.display = 'none';
            document.getElementById('chartError').style.display = 'none';

            try {
                console.log(`Starting analysis for ${coinId} over ${timeframe} days`);
                const priceData = await fetchPriceData(coinId, timeframe);
                
                // Calculate indicators
                console.log('Calculating technical indicators...');
                const sma20 = calculateSMA(priceData, 20);
                const rsi = calculateRSI(priceData);
                const bb = calculateBollingerBands(priceData);
                
                console.log('Indicators calculated:', {
                    pricePoints: priceData.length,
                    smaPoints: sma20.length,
                    rsiPoints: rsi.length,
                    bbPoints: bb.upper.length
                });
                
                // Generate signals
                const signals = generateTradingSignals(priceData, rsi, sma20, bb);
                const overallSignal = calculateOverallSignal(signals);
                
                // Display traditional analysis
                console.log('Creating chart...');
                displayChart(priceData, sma20, bb);
                displayIndicators(rsi, sma20, signals);
                displaySummary(overallSignal, signals.length, coinId.toUpperCase());
                
                // Final backup check to ensure chart is visible
                setTimeout(() => {
                    const canvas = document.getElementById('taChart');
                    if (canvas && chartInstance && (canvas.clientWidth === 0 || canvas.clientHeight === 0 || canvas.style.display === 'none')) {
                        console.log('üîß Chart not visible, attempting backup display...');
                        forceChartDisplay();
                    }
                }, 500);
                
                // ü§ñ PERFORM AI ANALYSIS
                console.log('ü§ñ Starting AI integration...');
                await performAIAnalysis(priceData, rsi, sma20, bb, signals, coinId);
                
                document.getElementById('loading').style.display = 'none';
                console.log('Analysis complete!');
                
                // Chart analysis complete
                console.log('‚úÖ Technical analysis complete with chart display!');
                
                // ‚úÖ SCROLL FIX: Restore scroll position to prevent unwanted scrolling
                window.scrollTo(0, currentScrollPosition);
                
            } catch (error) {
                console.error('Analysis error:', error);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('chartError').style.display = 'block';
                document.getElementById('chartError').innerHTML = `<strong>‚ö†Ô∏è Analysis Failed:</strong> ${error.message}. Please try a longer timeframe or check your connection.`;
                document.getElementById('indicators').innerHTML = '<div class="error">Analysis failed - please try again with a longer timeframe</div>';
                // ‚úÖ SCROLL FIX: Restore scroll position even on error
                window.scrollTo(0, currentScrollPosition);
            }
        }

        // Theme toggle functionality
        function handleThemeToggle() {
            document.body.classList.toggle('dark-theme');
            const isDark = document.body.classList.contains('dark-theme');
            
            document.getElementById('themeToggle').textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
            
            // Save theme preference
            localStorage.setItem('cryptoDashboardTheme', isDark ? 'dark' : 'light');
        }

        // üîß FIXED: Test chart functionality
        function testChart() {
            const canvas = document.getElementById('taChart');
            const ctx = canvas.getContext('2d');
            
            // Simple test chart to verify Chart.js is working
            const testChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Day 1', 'Day 2', 'Day 3', 'Day 4', 'Day 5'],
                    datasets: [{
                        label: 'Test Data',
                        data: [100, 150, 120, 180, 160],
                        borderColor: '#3B82F6',
                        backgroundColor: '#3B82F620',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'üìä Chart Test - Click Analyze to Load Real Data',
                            font: { size: 18, weight: 'bold' }
                        }
                    }
                }
            });
            
            // Show test chart
            canvas.style.display = 'block';
            canvas.style.visibility = 'visible';
            canvas.classList.add('visible');
            
            return testChart;
        }

        // Initialize theme and Bitcoin analysis
        window.onload = function() {
            // Load theme preference
            const savedTheme = localStorage.getItem('cryptoDashboardTheme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-theme');
                document.getElementById('themeToggle').textContent = '‚òÄÔ∏è';
            }
            
            // Set up theme toggle event listener
            document.getElementById('themeToggle').addEventListener('click', handleThemeToggle);
            
            // üîß FIXED: Show test chart to verify Chart.js is working
            setTimeout(() => {
                const testChartInstance = testChart();
                console.log('üß™ Test chart displayed - Chart.js is working!');
                
                // Store reference to destroy when real analysis runs
                window.testChartInstance = testChartInstance;
            }, 100);
            
            // You can uncomment the line below to auto-analyze Bitcoin on page load
            // analyzeTA();
        };
    </script>
</body>
</html> 