<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç Technical Analysis Module - Crypto Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }

        .header h1 {
            color: #2c3e50;
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .subtitle {
            color: #666;
            font-size: 1.1em;
            margin-bottom: 20px;
        }

        .disclaimer {
            background: linear-gradient(135deg, #ff9a56 0%, #ff6b6b 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: 500;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
        }

        .controls {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .control-group label {
            font-weight: 600;
            color: #555;
            font-size: 0.9em;
        }

        select, button {
            padding: 10px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            transition: all 0.3s ease;
        }

        select:focus, button:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            min-width: 120px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            border: 1px solid #e0e0e0;
        }

        .indicators-panel {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            border: 1px solid #e0e0e0;
        }

        .indicator {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            background: #f8f9fa;
        }

        .indicator h3 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1.1em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .indicator-value {
            font-size: 1.3em;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .signal {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .signal.buy, .signal.bullish {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }

        .signal.sell, .signal.bearish {
            background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);
            color: white;
        }

        .signal.neutral, .signal.hold {
            background: linear-gradient(135deg, #6c757d 0%, #adb5bd 100%);
            color: white;
        }

        .signal-strength {
            font-size: 0.8em;
            color: #666;
            margin-top: 5px;
        }

        .explanation {
            font-size: 0.85em;
            color: #666;
            margin-top: 8px;
            line-height: 1.4;
        }

        .loading {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 40px;
        }

        .error {
            background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            font-weight: 500;
        }

        .ta-summary {
            background: linear-gradient(135deg, #6c5ce7 0%, #a29bfe 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-top: 20px;
            text-align: center;
        }

        .ta-summary h3 {
            margin-bottom: 10px;
            font-size: 1.3em;
        }

        .overall-signal {
            font-size: 2em;
            font-weight: 700;
            margin: 10px 0;
        }

        .confidence {
            font-size: 0.9em;
            opacity: 0.9;
        }

        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
            
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .header h1 {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç Technical Analysis Module</h1>
            <p class="subtitle">Professional crypto technical indicators and signals</p>
            
            <div class="disclaimer">
                ‚ö†Ô∏è <strong>IMPORTANT DISCLAIMER:</strong> This is for educational purposes only. Technical analysis is not guaranteed to predict future price movements. Cryptocurrency trading involves significant risk of loss. Never invest more than you can afford to lose. This is NOT financial advice. Always do your own research and consult with qualified financial advisors.
            </div>
        </div>

        <div class="controls">
            <div class="control-group">
                <label for="coinSelect">Cryptocurrency:</label>
                <select id="coinSelect">
                    <option value="bitcoin">Bitcoin (BTC)</option>
                    <option value="ethereum">Ethereum (ETH)</option>
                    <option value="litecoin">Litecoin (LTC)</option>
                    <option value="dogecoin">Dogecoin (DOGE)</option>
                </select>
            </div>
            
            <div class="control-group">
                <label for="timeframe">Timeframe:</label>
                <select id="timeframe">
                    <option value="7">7 Days</option>
                    <option value="14">14 Days</option>
                    <option value="30">30 Days</option>
                </select>
            </div>
            
            <button onclick="analyzeTA()">üîç Analyze</button>
            <button onclick="location.href='../index.html'">üè† Back to Dashboard</button>
        </div>

        <div class="grid">
            <div class="chart-container">
                <h3>üìà Price Chart with Technical Indicators</h3>
                <div id="loading" class="loading">Click "Analyze" to load technical analysis...</div>
                <canvas id="taChart" style="display: none; height: 400px;"></canvas>
            </div>

            <div class="indicators-panel">
                <h3>üìä Technical Indicators</h3>
                <div id="indicators">
                    <div class="loading">Analysis results will appear here...</div>
                </div>
            </div>
        </div>

        <div id="taSummary" style="display: none;"></div>
    </div>

    <script>
        // Worker URL - Update this to your deployed worker
        const WORKER_URL = 'https://crypto-mood-dashboard.smah0085.workers.dev';
        
        let chartInstance = null;

        // Technical Analysis Functions
        function calculateSMA(data, period) {
            const sma = [];
            for (let i = period - 1; i < data.length; i++) {
                const sum = data.slice(i - period + 1, i + 1).reduce((a, b) => a + b.y, 0);
                sma.push({
                    x: data[i].x,
                    y: sum / period
                });
            }
            return sma;
        }

        function calculateRSI(data, period = 14) {
            const changes = [];
            for (let i = 1; i < data.length; i++) {
                changes.push(data[i].y - data[i - 1].y);
            }

            let avgGain = 0;
            let avgLoss = 0;

            // Initial average
            for (let i = 0; i < period; i++) {
                if (changes[i] > 0) avgGain += changes[i];
                else avgLoss += Math.abs(changes[i]);
            }
            avgGain /= period;
            avgLoss /= period;

            const rsi = [];
            for (let i = period; i < changes.length; i++) {
                if (changes[i] > 0) {
                    avgGain = (avgGain * (period - 1) + changes[i]) / period;
                    avgLoss = (avgLoss * (period - 1)) / period;
                } else {
                    avgGain = (avgGain * (period - 1)) / period;
                    avgLoss = (avgLoss * (period - 1) + Math.abs(changes[i])) / period;
                }

                const rs = avgGain / avgLoss;
                const rsiValue = 100 - (100 / (1 + rs));
                rsi.push({
                    x: data[i + 1].x,
                    y: rsiValue
                });
            }
            return rsi;
        }

        function calculateBollingerBands(data, period = 20, stdDev = 2) {
            const sma = calculateSMA(data, period);
            const bands = { upper: [], middle: [], lower: [] };
            
            for (let i = 0; i < sma.length; i++) {
                const dataSlice = data.slice(i, i + period);
                const mean = sma[i].y;
                const variance = dataSlice.reduce((sum, point) => sum + Math.pow(point.y - mean, 2), 0) / period;
                const standardDeviation = Math.sqrt(variance);
                
                bands.middle.push(sma[i]);
                bands.upper.push({
                    x: sma[i].x,
                    y: mean + (standardDeviation * stdDev)
                });
                bands.lower.push({
                    x: sma[i].x,
                    y: mean - (standardDeviation * stdDev)
                });
            }
            
            return bands;
        }

        function generateTradingSignals(price, rsi, sma, bb) {
            const signals = [];
            const currentPrice = price[price.length - 1].y;
            const currentRSI = rsi.length > 0 ? rsi[rsi.length - 1].y : 50;
            const currentSMA = sma.length > 0 ? sma[sma.length - 1].y : currentPrice;
            const currentBBUpper = bb.upper.length > 0 ? bb.upper[bb.upper.length - 1].y : currentPrice;
            const currentBBLower = bb.lower.length > 0 ? bb.lower[bb.lower.length - 1].y : currentPrice;

            // RSI Signals
            if (currentRSI < 30) {
                signals.push({ type: 'RSI', signal: 'BUY', strength: 'Strong', reason: 'Oversold condition (RSI < 30)' });
            } else if (currentRSI > 70) {
                signals.push({ type: 'RSI', signal: 'SELL', strength: 'Strong', reason: 'Overbought condition (RSI > 70)' });
            } else {
                signals.push({ type: 'RSI', signal: 'NEUTRAL', strength: 'Weak', reason: 'RSI in normal range (30-70)' });
            }

            // Moving Average Signals
            if (currentPrice > currentSMA * 1.02) {
                signals.push({ type: 'SMA', signal: 'BUY', strength: 'Medium', reason: 'Price above SMA with momentum' });
            } else if (currentPrice < currentSMA * 0.98) {
                signals.push({ type: 'SMA', signal: 'SELL', strength: 'Medium', reason: 'Price below SMA with momentum' });
            } else {
                signals.push({ type: 'SMA', signal: 'NEUTRAL', strength: 'Weak', reason: 'Price near SMA' });
            }

            // Bollinger Bands Signals
            if (currentPrice < currentBBLower) {
                signals.push({ type: 'BB', signal: 'BUY', strength: 'Medium', reason: 'Price below lower Bollinger Band' });
            } else if (currentPrice > currentBBUpper) {
                signals.push({ type: 'BB', signal: 'SELL', strength: 'Medium', reason: 'Price above upper Bollinger Band' });
            } else {
                signals.push({ type: 'BB', signal: 'NEUTRAL', strength: 'Weak', reason: 'Price within Bollinger Bands' });
            }

            return signals;
        }

        function calculateOverallSignal(signals) {
            let buyCount = 0;
            let sellCount = 0;
            let totalStrength = 0;

            signals.forEach(signal => {
                const strengthValue = signal.strength === 'Strong' ? 3 : signal.strength === 'Medium' ? 2 : 1;
                totalStrength += strengthValue;

                if (signal.signal === 'BUY') buyCount += strengthValue;
                else if (signal.signal === 'SELL') sellCount += strengthValue;
            });

            const buyPercentage = (buyCount / totalStrength) * 100;
            const sellPercentage = (sellCount / totalStrength) * 100;
            const confidence = Math.max(buyPercentage, sellPercentage);

            if (buyPercentage > 60) return { signal: 'BUY', confidence: confidence.toFixed(1) };
            else if (sellPercentage > 60) return { signal: 'SELL', confidence: confidence.toFixed(1) };
            else return { signal: 'HOLD', confidence: (100 - confidence).toFixed(1) };
        }

        async function fetchPriceData(coinId, days) {
            try {
                const response = await fetch(`${WORKER_URL}/history?coin=${coinId}&days=${days}`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                return data.prices.map(item => ({
                    x: new Date(item.timestamp),
                    y: item.price
                }));
            } catch (error) {
                console.error('Error fetching price data:', error);
                throw error;
            }
        }

        async function analyzeTA() {
            const coinId = document.getElementById('coinSelect').value;
            const timeframe = parseInt(document.getElementById('timeframe').value);
            
            document.getElementById('loading').style.display = 'block';
            document.getElementById('taChart').style.display = 'none';
            document.getElementById('indicators').innerHTML = '<div class="loading">Calculating indicators...</div>';
            document.getElementById('taSummary').style.display = 'none';

            try {
                const priceData = await fetchPriceData(coinId, timeframe);
                
                // Calculate indicators
                const sma20 = calculateSMA(priceData, 20);
                const rsi = calculateRSI(priceData);
                const bb = calculateBollingerBands(priceData);
                
                // Generate signals
                const signals = generateTradingSignals(priceData, rsi, sma20, bb);
                const overallSignal = calculateOverallSignal(signals);
                
                // Display chart
                displayChart(priceData, sma20, bb);
                
                // Display indicators
                displayIndicators(rsi, sma20, signals);
                
                // Display summary
                displaySummary(overallSignal, signals.length, coinId.toUpperCase());
                
                document.getElementById('loading').style.display = 'none';
                
            } catch (error) {
                document.getElementById('loading').innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        function displayChart(price, sma20, bb) {
            const ctx = document.getElementById('taChart').getContext('2d');
            
            if (chartInstance) {
                chartInstance.destroy();
            }

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [
                        {
                            label: 'Price',
                            data: price,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            borderWidth: 3,
                            fill: false,
                            tension: 0.1
                        },
                        {
                            label: 'SMA 20',
                            data: sma20,
                            borderColor: '#28a745',
                            borderWidth: 2,
                            fill: false,
                            pointRadius: 0
                        },
                        {
                            label: 'BB Upper',
                            data: bb.upper,
                            borderColor: '#dc3545',
                            borderWidth: 1,
                            borderDash: [5, 5],
                            fill: false,
                            pointRadius: 0
                        },
                        {
                            label: 'BB Lower',
                            data: bb.lower,
                            borderColor: '#dc3545',
                            borderWidth: 1,
                            borderDash: [5, 5],
                            fill: false,
                            pointRadius: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'day'
                            }
                        },
                        y: {
                            beginAtZero: false
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Technical Analysis Chart',
                            font: { size: 16 }
                        }
                    }
                }
            });

            document.getElementById('taChart').style.display = 'block';
        }

        function displayIndicators(rsi, sma20, signals) {
            const currentRSI = rsi.length > 0 ? rsi[rsi.length - 1].y : 0;

            const rsiSignal = signals.find(s => s.type === 'RSI');
            const smaSignal = signals.find(s => s.type === 'SMA');
            const bbSignal = signals.find(s => s.type === 'BB');

            document.getElementById('indicators').innerHTML = `
                <div class="indicator">
                    <h3>üìà RSI (14)</h3>
                    <div class="indicator-value">${currentRSI.toFixed(2)}</div>
                    <div class="signal ${rsiSignal.signal.toLowerCase()}">${rsiSignal.signal}</div>
                    <div class="signal-strength">${rsiSignal.strength} Signal</div>
                    <div class="explanation">${rsiSignal.reason}</div>
                </div>

                <div class="indicator">
                    <h3>üìä Moving Average (20)</h3>
                    <div class="signal ${smaSignal.signal.toLowerCase()}">${smaSignal.signal}</div>
                    <div class="signal-strength">${smaSignal.strength} Signal</div>
                    <div class="explanation">${smaSignal.reason}</div>
                </div>

                <div class="indicator">
                    <h3>üìè Bollinger Bands</h3>
                    <div class="signal ${bbSignal.signal.toLowerCase()}">${bbSignal.signal}</div>
                    <div class="signal-strength">${bbSignal.strength} Signal</div>
                    <div class="explanation">${bbSignal.reason}</div>
                </div>

                <div style="margin-top: 20px; padding: 15px; background: #f0f8ff; border-radius: 10px; font-size: 0.9em;">
                    <strong>üìö Educational Notes:</strong><br>
                    ‚Ä¢ RSI < 30: Potentially oversold<br>
                    ‚Ä¢ RSI > 70: Potentially overbought<br>
                    ‚Ä¢ Price above SMA: Potential uptrend<br>
                    ‚Ä¢ BB squeeze: Low volatility period
                </div>
            `;
        }

        function displaySummary(overallSignal, totalSignals, coin) {
            const signalClass = overallSignal.signal.toLowerCase();
            const emoji = overallSignal.signal === 'BUY' ? 'üöÄ' : overallSignal.signal === 'SELL' ? 'üìâ' : '‚è∏Ô∏è';

            document.getElementById('taSummary').innerHTML = `
                <div class="ta-summary">
                    <h3>üìã Technical Analysis Summary for ${coin}</h3>
                    <div class="overall-signal">${emoji} ${overallSignal.signal}</div>
                    <div class="confidence">Confidence: ${overallSignal.confidence}%</div>
                    <div style="margin-top: 15px; font-size: 0.9em;">
                        Based on ${totalSignals} technical indicators
                    </div>
                    <div style="margin-top: 15px; font-size: 0.85em; opacity: 0.9; border-top: 1px solid rgba(255,255,255,0.3); padding-top: 15px;">
                        <strong>‚ö†Ô∏è Remember:</strong> Technical analysis is not a crystal ball. It helps identify trends and patterns, but markets can be unpredictable. This is educational content only, not investment advice. Always do your own research and never invest more than you can afford to lose.
                    </div>
                </div>
            `;
            
            document.getElementById('taSummary').style.display = 'block';
        }

        // Initialize with Bitcoin analysis
        window.onload = function() {
            // You can uncomment the line below to auto-analyze Bitcoin on page load
            // analyzeTA();
        };
    </script>
</body>
</html> 