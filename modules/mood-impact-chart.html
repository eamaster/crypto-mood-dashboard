<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mood Impact Chart Demo</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        input, button {
            padding: 10px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        button {
            background: #007bff;
            color: white;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
        .chart-container {
            margin-top: 20px;
            height: 500px;
            position: relative;
        }
        .sentiment-summary {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .sentiment-badge {
            font-size: 24px;
            font-weight: bold;
            padding: 10px 20px;
            border-radius: 20px;
        }
        .sentiment-bullish {
            background: #d4edda;
            color: #155724;
        }
        .sentiment-neutral {
            background: #e9ecef;
            color: #495057;
        }
        .sentiment-bearish {
            background: #f8d7da;
            color: #721c24;
        }
        .error {
            color: #dc3545;
            margin-top: 20px;
            padding: 15px;
            background: #f8d7da;
            border-radius: 5px;
        }
        .loading {
            text-align: center;
            margin-top: 20px;
            font-size: 18px;
        }
        .news-preview {
            margin-top: 15px;
            max-height: 150px;
            overflow-y: auto;
            font-size: 12px;
            color: #666;
        }
        .news-item {
            padding: 5px;
            margin: 2px 0;
            background: white;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìä Mood Impact Chart Demo</h1>
        <p>Combines 7-day price data with today's sentiment analysis from cryptocurrency news headlines:</p>
        
        <div>
            <input type="text" id="coinId" placeholder="bitcoin" value="bitcoin">
            <button onclick="fetchMoodImpactData()">Generate Chart</button>
        </div>
        
        <div id="loading" class="loading" style="display: none;">
            ‚è≥ Loading price data and analyzing sentiment...
        </div>
        
        <div id="error" class="error" style="display: none;"></div>
        
        <div id="sentimentSummary" class="sentiment-summary" style="display: none;">
            <div>
                <strong>Today's Market Sentiment:</strong>
                <div id="sentimentBadge" class="sentiment-badge"></div>
            </div>
            <div>
                <div><strong>Headlines analyzed:</strong> <span id="headlineCount">0</span></div>
                <div><strong>Average score:</strong> <span id="averageScore">0</span></div>
            </div>
        </div>
        
        <div id="newsPreview" class="news-preview" style="display: none;"></div>
        
        <div class="chart-container">
            <canvas id="moodImpactChart"></canvas>
        </div>
    </div>

    <script>
        // Using Coingecko API directly
        const COINGECKO_API = 'https://api.coingecko.com/api/v3';
        // News API is disabled for now since it requires a working endpoint
        const ENABLE_NEWS = false;
        
        let chartInstance = null;
        
        // Enhanced validation functions
        function validatePriceData(data) {
            if (!data || !Array.isArray(data)) {
                console.error('Price data is not an array:', data);
                return false;
            }
            return data.every(point => {
                const isValid = point && 
                    point.x instanceof Date && 
                    typeof point.y === 'number' && 
                    point.y > 0;
                
                if (!isValid) {
                    console.warn('Invalid price point:', point);
                }
                return isValid;
            });
        }
        
        function validateNewsData(data) {
            if (!data || !Array.isArray(data)) return false;
            return data.every(article => 
                article && 
                typeof article === 'object' && 
                (typeof article.title === 'string' || typeof article === 'string') &&
                (article.title || article).length > 0
            );
        }
        
        function validateSentimentData(data) {
            if (!data || typeof data !== 'object') return false;
            if (typeof data.score !== 'number' || data.score < -5 || data.score > 5) return false;
            if (!data.category || !['bullish', 'bearish', 'neutral'].includes(data.category)) return false;
            if (typeof data.confidence !== 'number' || data.confidence < 0 || data.confidence > 1) return false;
            return true;
        }
        
        async function fetchMoodImpactData() {
            const coinId = document.getElementById('coinId').value.trim() || 'bitcoin';
            const loadingDiv = document.getElementById('loading');
            const errorDiv = document.getElementById('error');
            const sentimentSummary = document.getElementById('sentimentSummary');
            const newsPreview = document.getElementById('newsPreview');
            
            try {
                console.log('Starting enhanced fetchMoodImpactData for:', coinId);
                
                // Show loading, hide other elements
                loadingDiv.style.display = 'block';
                errorDiv.style.display = 'none';
                sentimentSummary.style.display = 'none';
                newsPreview.style.display = 'none';
                
                // Destroy existing chart
                if (chartInstance) {
                    chartInstance.destroy();
                    chartInstance = null;
                }
                
                console.log('Fetching real price data and news with validation...');
                // Fetch price data and news in parallel with enhanced error handling
                const [priceData, newsData] = await Promise.all([
                    fetchPriceData(coinId),
                    fetchNewsData(coinId).catch(err => {
                        console.warn('üì∞ News fetch failed, using empty array:', err.message);
                        return []; // Return empty array on news error to continue with price-only chart
                    })
                ]);
                
                console.log('üìà Real price data received:', priceData.length, 'points from CoinGecko');
                console.log('üì∞ News data received:', newsData.length, 'headlines');
                
                // Validate data before processing
                console.log('Validating price data:', priceData);
                if (!validatePriceData(priceData)) {
                    console.error('Price data validation failed:', priceData);
                    throw new Error('Invalid price data format - check console for details');
                }
                
                if (newsData.length > 0 && !validateNewsData(newsData)) {
                    console.warn('Invalid news data received, proceeding with empty news array');
                    newsData.length = 0; // Clear invalid news data
                }
                
                // Analyze sentiment with enhanced validation
                console.log('Analyzing sentiment with improved confidence calculations...');
                const sentimentData = await analyzeSentimentData(newsData);
                console.log('Enhanced sentiment analysis result:', sentimentData);
                
                // Validate sentiment data
                if (!validateSentimentData(sentimentData)) {
                    console.warn('Invalid sentiment data, using neutral fallback');
                    sentimentData.score = 0;
                    sentimentData.category = 'neutral';
                    sentimentData.confidence = 0;
                    sentimentData.method = 'fallback';
                }
                
                // Create enhanced chart with real data
                createMoodImpactChart(priceData, sentimentData, coinId);
                
                // Update UI with enhanced information
                updateSentimentSummary(sentimentData);
                updateNewsPreview(newsData);
                
                loadingDiv.style.display = 'none';
                sentimentSummary.style.display = 'flex';
                newsPreview.style.display = 'block';
                
            } catch (error) {
                console.error('Error fetching mood impact data:', error);
                loadingDiv.style.display = 'none';
                errorDiv.style.display = 'block';
                errorDiv.textContent = `‚ùå Error: ${error.message}`;
            }
        }
        
        async function fetchPriceData(coinId) {
            try {
                // Try Coingecko API directly first
                console.log(`üìà Fetching price data for ${coinId} from CoinGecko...`);
                const response = await fetch(
                    `${COINGECKO_API}/coins/${coinId}/market_chart?vs_currency=usd&days=7&interval=daily`
                );
                
                if (!response.ok) {
                    throw new Error(`Failed to fetch price data: HTTP ${response.status}`);
                }
                
                const data = await response.json();
                console.log('üìä Raw price data from CoinGecko:', data);
                
                if (!data.prices || !Array.isArray(data.prices)) {
                    throw new Error('Invalid price data format from API');
                }
                
                // Format the data for the chart
                const chartData = data.prices.map(([timestamp, price]) => {
                    const date = new Date(timestamp);
                    return {
                        x: date,
                        y: price,
                        // Keep original timestamp for debugging
                        timestamp: date.toISOString(),
                        price: price
                    };
                });
                
                console.log(`‚úÖ Fetched ${chartData.length} price points for ${coinId}`, chartData);
                return chartData;
            } catch (error) {
                console.error('Error in fetchPriceData:', error);
                throw new Error(`Failed to fetch price data for ${coinId}: ${error.message}`);
            }
        }
        
        async function fetchNewsData(coinId) {
            if (!ENABLE_NEWS) {
                console.log('‚ÑπÔ∏è News fetching is currently disabled');
                return [];
            }
            
            try {
                console.log(`üì∞ News feature is currently disabled`);
                return [];
                
                const data = await response.json();
                console.log('üì∞ Enhanced News API response:', data);
                
                if (data.error) {
                    console.error('News API error:', data.error);
                    throw new Error(`News API error: ${data.error}`);
                }
                
                if (!data.headlines || data.headlines.length === 0) {
                    console.warn(`‚ö†Ô∏è No news headlines found for ${coinId}`);
                    return []; // Return empty array if no news found
                }
                
                // Validate news data
                if (!validateNewsData(data.headlines)) {
                    throw new Error('Invalid news data format received');
                }
                
                console.log(`‚úÖ Successfully fetched ${data.headlines.length} validated headlines for ${coinId} from ${data.source || 'NewsAPI'}`);
                return data.headlines;
                
            } catch (error) {
                console.error('‚ùå Enhanced news fetch failed:', error.message);
                throw error; // Re-throw to show error in UI instead of silent failure
            }
        }
        
        async function analyzeSentimentData(headlines) {
            console.log(`üß† Starting enhanced sentiment analysis for ${headlines.length} headlines...`);
            
            if (headlines.length === 0) {
                console.warn('‚ö†Ô∏è No headlines to analyze, returning neutral sentiment');
                return {
                    score: 0,
                    category: 'neutral',
                    emoji: 'üòê',
                    count: 0,
                    confidence: 0,
                    method: 'no-data',
                    note: 'No headlines available for analysis'
                };
            }
            
            try {
                console.log('üîó Calling enhanced sentiment analysis API...');
                const response = await fetch(`${WORKER_URL}/sentiment`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        headlines: headlines
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`Sentiment analysis failed: HTTP ${response.status}`);
                }
                
                const data = await response.json();
                console.log('üß† Enhanced sentiment analysis response:', data);
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                // Validate sentiment response
                if (!validateSentimentData(data)) {
                    throw new Error('Invalid sentiment data received from server');
                }
                
                let emoji;
                if (data.category === 'bullish') {
                    emoji = 'üêÇ';
                } else if (data.category === 'bearish') {
                    emoji = 'üêª';
                } else {
                    emoji = 'üòê';
                }
                
                const result = {
                    score: data.score || 0,
                    category: data.category || 'neutral',
                    emoji: emoji,
                    count: data.total || data.analyzed || headlines.length,
                    confidence: data.confidence || 0,
                    method: data.method || 'unknown',
                    breakdown: data.breakdown || null,
                    metrics: data.metrics || null
                };
                
                console.log('‚úÖ Enhanced sentiment analysis complete:', result);
                return result;
                
            } catch (error) {
                console.error('‚ùå Error in enhanced sentiment analysis:', error);
                return {
                    score: 0,
                    category: 'neutral',
                    emoji: 'üòê',
                    count: headlines.length,
                    confidence: 0,
                    method: 'error',
                    error: error.message
                };
            }
        }
        
        function createMoodImpactChart(priceData, sentimentData, coinId) {
            const ctx = document.getElementById('moodImpactChart').getContext('2d');
            
            // Double-check Chart.js is available
            if (typeof Chart === 'undefined') {
                throw new Error('Chart.js library is not available');
            }
            
            console.log('üìä Creating chart with:', {
                pricePoints: priceData.length,
                sentimentScore: sentimentData.score,
                sentimentCategory: sentimentData.category,
                headlinesCount: sentimentData.count
            });
            
            // Create sentiment bar data - position it at the end of the week for today's sentiment
            const sentimentBarData = [{
                x: priceData[priceData.length - 1].x, // Use last date from price data
                y: sentimentData.score || 0
            }];
            
            // Determine sentiment bar color with defensive programming
            const category = sentimentData.category || 'neutral';
            let sentimentColor;
            if (category === 'bullish') {
                sentimentColor = 'rgba(40, 167, 69, 0.8)';
            } else if (category === 'bearish') {
                sentimentColor = 'rgba(220, 53, 69, 0.8)';
            } else {
                sentimentColor = 'rgba(108, 117, 125, 0.8)';
            }
            
            console.log(`üìä Chart color: ${sentimentColor} for ${category} sentiment`);
            
            // Add validation for empty data
            if (!priceData || priceData.length === 0) {
                throw new Error('No price data available for chart');
            }
            
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [
                        {
                            label: `${coinId.toUpperCase()} Price (USD)`,
                            data: priceData,
                            borderColor: '#007bff',
                            backgroundColor: 'rgba(0, 123, 255, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.1,
                            yAxisID: 'price'
                        },
                        {
                            label: 'Today\'s Sentiment',
                            data: sentimentBarData,
                            type: 'bar',
                            backgroundColor: sentimentColor,
                            borderColor: sentimentColor.replace('0.8', '1'),
                            borderWidth: 1,
                            yAxisID: 'sentiment',
                            barThickness: 30
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'day',
                                displayFormats: {
                                    day: 'MMM dd'
                                }
                            },
                            title: {
                                display: true,
                                text: 'Date'
                            }
                        },
                        price: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Price (USD)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        },
                        sentiment: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Sentiment Score'
                            },
                            min: -5,
                            max: 5,
                            grid: {
                                drawOnChartArea: false,
                            },
                            ticks: {
                                callback: function(value) {
                                    if (value > 1) return value + ' (Bullish)';
                                    if (value < -1) return value + ' (Bearish)';
                                    return value + ' (Neutral)';
                                }
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: `${coinId.toUpperCase()} Price vs Market Sentiment`,
                            font: {
                                size: 16
                            }
                        },
                        legend: {
                            display: true
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    if (context.dataset.label.includes('Price')) {
                                        return `Price: ${context.parsed.y.toLocaleString('en-US', {
                                            style: 'currency',
                                            currency: 'USD'
                                        })}`;
                                    } else {
                                        return `Sentiment: ${context.parsed.y.toFixed(2)} (${sentimentData.category || 'neutral'})`;
                                    }
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function updateSentimentSummary(sentimentData) {
            const badge = document.getElementById('sentimentBadge');
            const headlineCount = document.getElementById('headlineCount');
            const averageScore = document.getElementById('averageScore');
            
            // Defensive programming - ensure all required properties exist
            const emoji = sentimentData.emoji || 'üòê';
            const category = sentimentData.category || 'neutral';
            const count = sentimentData.count || 0;
            const score = sentimentData.score || 0;
            
            console.log('üìä Updating sentiment summary:', { emoji, category, count, score });
            
            badge.textContent = `${emoji} ${category.charAt(0).toUpperCase() + category.slice(1)}`;
            badge.className = `sentiment-badge sentiment-${category}`;
            
            headlineCount.textContent = count;
            let scoreText = score.toFixed(2);
            
            // Add additional context
            if (sentimentData.method) {
                scoreText += ` (${sentimentData.method === 'cohere-chat-api' ? 'AI' : 'Keyword'})`;
            }
            if (sentimentData.confidence) {
                scoreText += ` ‚Ä¢ ${(sentimentData.confidence * 100).toFixed(0)}% confidence`;
            }
            if (sentimentData.error) {
                scoreText += ` ‚Ä¢ Error: ${sentimentData.error}`;
            }
            
            averageScore.textContent = scoreText;
        }
        
        function updateNewsPreview(headlines) {
            const newsPreview = document.getElementById('newsPreview');
            
            if (headlines.length === 0) {
                newsPreview.innerHTML = '<div class="news-item">No news headlines found for sentiment analysis.</div>';
                return;
            }
            
            newsPreview.innerHTML = `
                <strong>Headlines analyzed for sentiment:</strong>
                ${headlines.slice(0, 5).map((article, index) => `
                    <div class="news-item">${index + 1}. ${escapeHtml(article.title || article)}</div>
                `).join('')}
                ${headlines.length > 5 ? `<div class="news-item">... and ${headlines.length - 5} more</div>` : ''}
            `;
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Allow Enter key to trigger fetch
        document.getElementById('coinId').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                fetchMoodImpactData();
            }
        });
        
        // Auto-load chart on page load
        window.addEventListener('load', function() {
            // Wait a bit for Chart.js to fully load
            setTimeout(() => {
                if (typeof Chart === 'undefined') {
                    document.getElementById('error').style.display = 'block';
                    document.getElementById('error').textContent = '‚ùå Error: Chart.js failed to load. Please refresh the page.';
                    return;
                }
                fetchMoodImpactData();
            }, 100);
        });
    </script>
</body>
</html> 